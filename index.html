<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cenov√° ponuka</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
*{ box-sizing:border-box; }
body{ margin:0; font-family:"Onest", system-ui, sans-serif; background:#fff; color:#000; }
.wrap{ max-width:1200px; margin:0 auto; padding:24px; }
h1{ margin:0 0 14px 0; font-size:28px; font-weight:800; }

.toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 16px; }
.btn{
  border-radius:999px; padding:10px 16px;
  border:1px solid #000; background:#fff;
  font-weight:800; cursor:pointer;
}
.btn.primary{ background:#000; color:#fff; }
.btn.secondary{ background:#f2f2f2; border-color:#d0d0d0; }
.btn.ghost{ background:#fff; border-color:#d0d0d0; }

.icon-btn{
  width:40px; height:40px; border-radius:999px;
  border:1px solid #d0d0d0; background:#f2f2f2;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
}
.icon-btn.danger{
  border-color:#ffb3b3;
  background:#ffe6e6;
  color:#b00020;
}

.hint{ color:#666; font-size:13px; margin-top:4px; }

label{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.08em;
  font-weight:800;
  display:block;
  margin-bottom:4px;
  color:#111;
}
input, select, textarea{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-family:inherit;
  font-size:14px;
  background:#fff;
}
input[type="number"]{ text-align:right; }
textarea{ min-height:70px; resize:vertical; }
.small{ font-size:12px; color:#666; }

select.important, input.important{
  border:2px solid #1f5fff !important;
  font-weight:800 !important;
}

.card{ border:1px solid #ddd; border-radius:16px; padding:16px; margin-bottom:16px; }
.card h2{ margin:0 0 12px 0; font-size:18px; font-weight:800; }

.grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
.grid-4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:14px; }
@media (max-width: 900px){
  .grid-2,.grid-3,.grid-4{ grid-template-columns:1fr; }
}

.sections{ display:flex; flex-direction:column; gap:14px; }
.section{ border:2px solid #000; border-radius:16px; padding:14px; }

.section-head{
  display:flex;
  gap:10px;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
  margin-bottom:10px;
  padding-bottom:10px;
  border-bottom:1px dashed #ddd;
}
.section-title{
  display:grid;
  grid-template-columns: 1fr 220px;
  gap:12px;
  width:100%;
}
@media (max-width: 900px){
  .section-title{ grid-template-columns:1fr; }
}
.section-actions{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
  margin-left:auto;
}
.section-bottom{
  margin-top:12px;
  padding-top:12px;
  border-top:1px dashed #ddd;
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}

.items{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
.item{ border:1px solid #ddd; border-radius:14px; padding:12px; }
.item-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
.item-head .left{ font-weight:800; }
.item-head .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

.item-foot{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
  flex-wrap:wrap;
}
.price-block{ text-align:right; min-width:260px; }
.price-old{ font-size:12px; color:#777; text-decoration:line-through; min-height:16px; }
.price-main{ font-weight:800; font-size:18px; }
.price-period{ margin-top:2px; font-size:11px; color:#777; }

.or-sep{
  text-align:center;
  font-weight:900;
  letter-spacing:.12em;
  color:#111;
  background:#f3f3f3;
  border:1px solid #ddd;
  border-radius:999px;
  padding:8px 10px;
  margin:2px 0;
}

.preview-row{
  margin-top:10px;
  display:flex;
  gap:12px;
  align-items:flex-start;
  flex-wrap:wrap;
}
.thumb{
  width:120px;
  height:90px;
  border:1px solid #ddd;
  border-radius:12px;
  overflow:hidden;
  background:#f6f6f6;
  display:flex;
  align-items:center;
  justify-content:center;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:10px;
}

.note-box{ margin-top:10px; }

.images-off .img-controls{ display:none !important; }

/* DIGITAL PANEL (edit UI) */
.dp-wrap{ margin-top:12px; }
.dp-top-table{ border:1px solid #ddd; border-radius:14px; padding:12px; }
.dp-row{
  display:grid;
  grid-template-columns: 140px 1fr 1fr 1fr 120px;
  gap:10px;
  align-items:end;
  margin-top:10px;
}
@media (max-width: 900px){
  .dp-row{ grid-template-columns:1fr; }
}
.dp-row .dp-actions{ display:flex; gap:8px; justify-content:flex-end; }
.dp-row:first-child{ margin-top:0; }

.dp-spec{
  border:1px solid #ddd;
  border-radius:14px;
  padding:12px;
  margin-top:12px;
}
.dp-spec-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  flex-wrap:wrap;
}
.dp-months{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
.dp-month{
  border:1px dashed #ddd;
  border-radius:12px;
  padding:10px;
}
.dp-month-grid{
  display:grid;
  grid-template-columns: 1fr 160px 160px;
  gap:10px;
}
@media (max-width: 900px){
  .dp-month-grid{ grid-template-columns:1fr; }
}

/* PRINT VIEW */
.print-view{ display:none; }

.print-page{
  width:210mm;
  min-height:297mm;
  margin:0 auto;
  background:#fff;
  border:2px solid #000;
  padding:18mm 14mm 22mm 14mm; /* bottom a tro≈°ku viac kv√¥li footeru */
  position:relative;
}

.pv-logo{
  position:absolute;
  top:10mm;
  right:14mm;
  width:26mm;
  height:auto;
  opacity:0.95;
}

.pv-gutter{
  position:absolute;
  left:14mm;
  top:18mm;
  bottom:26mm; /* nech nezasahuje do footeru */
  width:42mm;
  display:flex;
  flex-direction:column;
  gap:10mm;
}

.pv-gutter .pv-img{
  width:100%;
  border-radius:3mm;
  overflow:hidden;
  border:1px solid #ddd;
  background:#f6f6f6;
}
.pv-gutter .pv-img img{
  width:100%;
  height:auto;
  display:block;
  border-radius:3mm; /* jemn√© zaoblenie aj pre istotu */
}

.pv-content{ margin-left:48mm; }

.pv-header{ margin-bottom:12mm; }
.pv-title{ font-size:34px; font-weight:800; }
.pv-subtitle{ font-size:16px; margin-top:4px; font-weight:500; }

.pv-section{
  margin-top:12mm;
  break-inside: avoid;
  page-break-inside: avoid;
}
.pv-section-name{ font-size:13px; font-weight:700; }
.pv-section-period{ margin-top:2mm; font-size:12px; font-weight:500; color:#111; }

.pv-table{
  margin-top:6mm;
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:11.5px;
  break-inside: avoid;
  page-break-inside: avoid;
}
.pv-table thead{ break-inside: avoid; page-break-inside: avoid; }
.pv-table tr{ break-inside: avoid; page-break-inside: avoid; }

.pv-table th{
  text-align:left;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.08em;
  border-bottom:1px solid #000;
  padding-bottom:6px;
}
.pv-table td{
  padding:8px 0;
  vertical-align:top;
}

.c-item{ width:38%; }
.c-spec{ width:20%; }
.c-qty{ width:10%; text-align:right; }
.c-price{ width:14%; text-align:right; }
.c-disc{ width:14%; text-align:right; }
.c-total{ width:16%; text-align:right; }

.pv-item-title{ font-weight:700; }
.pv-item-note{ font-size:10.5px; margin-top:2px; color:#111; }
.pv-item-period{ margin-top:3px; font-size:10px; color:#777; }
.pv-divider{ margin-top:10mm; border-top:1px solid #000; }

.pv-no-images .pv-gutter{ display:none; }
.pv-no-images .pv-content{ margin-left:0; }

.pv-or-row td{
  padding:10px 0;
  text-align:center !important;
  font-weight:900;
  letter-spacing:.12em;
  color:#111;
}

/* DIGITAL PANEL in PDF */
.pv-dp-top{
  margin-top:6mm;
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:11.5px;
}
.pv-dp-top th{
  text-align:left;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.08em;
  border-bottom:1px solid #000;
  padding-bottom:6px;
}
.pv-dp-top td{ padding:8px 0; vertical-align:top; }
.pv-dp-pricecell{ text-align:right; }
.pv-dp-zh{
  color:#d35400;
  font-weight:800;
  font-size:11px;
  display:block;
  margin-top:3px;
}

.pv-dp-spec-title{
  font-weight:800;
  margin-top:6mm;
}
.pv-dp-month-table{
  margin-top:3mm;
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:11.5px;
}
.pv-dp-month-table th{
  text-align:left;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.08em;
  border-bottom:1px solid #000;
  padding-bottom:6px;
}
.pv-dp-month-table td{ padding:7px 0; vertical-align:top; border-bottom:1px solid #eee; }
.pv-dp-month-table .r{ text-align:right; }

/* footer on each page */
.pv-footer{
  position:fixed;
  left:14mm;
  right:14mm;
  bottom:8mm;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10mm;
  font-size:11px;
}
.pv-footer .pv-feel{
  height:10mm;
  width:auto;
  opacity:.95;
}
.pv-footer a{ color:#000; text-decoration:none; }
.pv-footer .mid{ text-align:center; flex:1; }
.pv-footer .right{ text-align:right; min-width:50mm; }

@media print{
  .wrap{ display:none !important; }
  .print-view{ display:block !important; }
  body{ margin:0; }
  @page{ margin:0; }
}
</style>
</head>

<body>

<div class="wrap" id="appRoot">
  <h1>Cenov√° ponuka ‚Äì formul√°r</h1>

  <div class="toolbar">
    <button class="btn primary" id="btnPrint" type="button">Export do PDF</button>
    <button class="btn secondary" id="btnAddSection" type="button">+ Prida≈• sekciu</button>
    <button class="btn ghost" id="btnReset" type="button">Vymaza≈• (demo)</button>
  </div>
  <div class="hint">Cena spolu v riadku je v≈ædy. Voliteƒæn√Ω je iba fin√°lny s√∫ƒçet v≈°etk√Ωch polo≈æiek.</div>

  <div class="card">
    <h2>Z√°klad ponuky</h2>

    <div class="grid-2">
      <div>
        <label for="offerTitle">N√°zov ponuky</label>
        <input id="offerTitle" class="important" value="Cenov√° ponuka">
      </div>
      <div>
        <label for="offerSubtitle">Podnadpis</label>
        <input id="offerSubtitle" placeholder="napr. Digit√°lny panel v ƒçak√°rni pediatra" value="">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label for="fileName">N√°zov s√∫boru (PDF)</label>
        <input id="fileName" class="important" placeholder="napr. DP_pediater_Q2_2026" value="">
        <div class="small">Pri exporte sa automaticky dopln√≠ d√°tum pred n√°zov (YYYY-MM-DD_...).</div>
      </div>
      <div>
        <label for="pdfShowGrand">Zobrazi≈• fin√°lny s√∫ƒçet (Spolu) v PDF?</label>
        <select id="pdfShowGrand" class="important">
          <option value="no" selected>Nie</option>
          <option value="yes">√Åno</option>
        </select>
        <div class="small">Pozor: ‚ÄûCena spolu‚Äú pri polo≈æk√°ch je v≈ædy, toto je len fin√°lny s√∫ƒçet na konci.</div>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Sekcie</h2>
    <div class="sections" id="sections"></div>

    <div class="hint" style="margin-top:10px;">
      Tip: Logo IDS sa naƒç√≠ta zo s√∫boru <strong>ids-logo.png</strong> v rovnakom prieƒçinku ako index.html.
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label for="pdfImages">PDF obr√°zky</label>
        <select id="pdfImages">
          <option value="with" selected>S obr√°zkami</option>
          <option value="without">Bez obr√°zkov (cel√° ≈°√≠rka)</option>
        </select>
      </div>
      <div style="text-align:right; align-self:end;">
        <button class="btn secondary" id="btnAddSectionBottom" type="button">+ Prida≈• sekciu</button>
      </div>
    </div>
  </div>
</div>

<!-- PRINT VIEW -->
<section class="print-view" id="printView">
  <div class="print-page" id="printPage">
    <img class="pv-logo" id="pvLogo" src="ids-logo.png" alt="IDS logo" />

    <div class="pv-gutter" id="pvGutter"></div>

    <div class="pv-content">
      <div class="pv-header">
        <div class="pv-title" id="pvTitle">Cenov√° ponuka</div>
        <div class="pv-subtitle" id="pvSubtitle"></div>
      </div>

      <div id="pvSections"></div>
      <div id="pvGrandWrap"></div>

      <div style="margin-top:10mm; font-size:11px; font-weight:600;">Ceny s√∫ bez DPH.</div>
    </div>

    <div class="pv-footer">
      <img class="pv-feel" id="pvFeel" src="Feel.png" alt="feel the good network">
      <div class="mid"><a href="https://www.ids-media.sk" target="_blank" rel="noopener">www.ids-media.sk</a></div>
      <div class="right" id="pvGenerated">Generovan√©: ‚Äî</div>
    </div>
  </div>
</section>

<!-- DATALISTS -->
<datalist id="dlSectionNames">
  <option value="Komunik√°cia v ƒçak√°rni pediatra"></option>
  <option value="Komunik√°cia v ƒçak√°rni gynekol√≥ga"></option>
  <option value="Komunik√°cia v ƒçak√°rni praktick√©ho lek√°ra"></option>
  <option value="Komunik√°cia v ƒçak√°rni urol√≥ga"></option>
  <option value="Osobn√° n√°v≈°teva lek√°ra"></option>
  <option value="Komunik√°cia v lek√°rni"></option>
  <option value="Digit√°lny panel v ƒçak√°rni lek√°ra"></option>
</datalist>

<datalist id="dlTypes">
  <option value="A3 plag√°t"></option>
  <option value="B1 plag√°t"></option>
  <option value="Statick√Ω plag√°t"></option>
  <option value="Umiestnenie let√°kov"></option>
  <option value="Odovzdanie materi√°lov"></option>
  <option value="Tlaƒç materi√°lov"></option>
</datalist>

<datalist id="dlSpec">
  <option value="Praktick√Ω lek√°r"></option>
  <option value="Pediater"></option>
  <option value="Gynekol√≥g"></option>
  <option value="Urol√≥g"></option>
  <option value="Gastroenterol√≥g"></option>
</datalist>

<datalist id="dlMonths">
  <option value="Janu√°r"></option><option value="Febru√°r"></option><option value="Marec"></option>
  <option value="Apr√≠l"></option><option value="M√°j"></option><option value="J√∫n"></option>
  <option value="J√∫l"></option><option value="August"></option><option value="September"></option>
  <option value="Okt√≥ber"></option><option value="November"></option><option value="December"></option>
</datalist>

<!-- TEMPLATES -->
<template id="tplSection">
  <div class="section" data-section>
    <div class="section-head">
      <div class="section-title">
        <div>
          <label>N√°zov sekcie</label>
          <input data-sec-name class="important" list="dlSectionNames" placeholder="napr. Komunik√°cia v ƒçak√°rni pediatra" value="">
          <div class="small">M√¥≈æe≈° vybra≈• zo zoznamu alebo nap√≠sa≈• vlastn√Ω n√°zov.</div>
        </div>
        <div>
          <label>Obdobie (Q)</label>
          <input data-sec-period class="important" placeholder="napr. Q2 2026" value="">
        </div>

        <div class="grid-2" style="grid-column:1/-1; margin-top:10px;">
          <div>
            <label>Typ sekcie</label>
            <select data-sec-kind class="important">
              <option value="standard" selected>≈†tandardn√© plochy</option>
              <option value="dp">Digit√°lny panel</option>
            </select>
          </div>
          <div style="display:flex; align-items:end; justify-content:flex-end;">
            <button class="icon-btn danger" type="button" title="Odstr√°ni≈• sekciu" data-del-section>üóëÔ∏è</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STANDARD -->
    <div data-standard>
      <div class="items" data-items></div>
      <div class="section-bottom">
        <button class="btn secondary" type="button" data-add-item>+ Prida≈• polo≈æku</button>
      </div>
    </div>

    <!-- DIGITAL PANEL -->
    <div data-dp class="dp-wrap" style="display:none;">
      <div class="dp-top-table">
        <div class="grid-2">
          <div>
            <label>N√°zov produktu v DP (hlaviƒçka)</label>
            <input data-dp-title class="important" value="Spot v digit√°lnom paneli">
          </div>
          <div>
            <label>Jednotka ceny</label>
            <input data-dp-unit value="Cena / 1 panel / mesiac">
          </div>
        </div>

        <div style="margin-top:10px;">
          <label>Spoty (sekundy a ceny)</label>
          <div data-dp-spots></div>
          <div style="margin-top:10px; text-align:right;">
            <button class="btn secondary" type="button" data-dp-add-spot>+ Prida≈• spot</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px;">
        <div class="grid-2">
          <div>
            <label>≈†pecializ√°cie</label>
            <div class="small">Ka≈æd√° ≈°pecializ√°cia m√° vlastn√∫ fotku + mesiace.</div>
          </div>
          <div style="text-align:right;">
            <button class="btn secondary" type="button" data-dp-add-spec>+ Prida≈• ≈°pecializ√°ciu</button>
          </div>
        </div>

        <div data-dp-specs></div>

        <div style="margin-top:12px;">
          <div class="grid-2">
            <div>
              <label>Text pod digit√°lnymi panelmi (voliteƒæn√©)</label>
              <textarea data-dp-note></textarea>
              <div class="small">Ak nech√°≈° pr√°zdne, v PDF sa niƒç nezobraz√≠.</div>
            </div>
            <div>
              <label>Zobrazi≈• s√∫ƒçty dole (Spolu za 15/20/30‚Ä¶)</label>
              <select data-dp-show-totals class="important">
                <option value="yes" selected>√Åno</option>
                <option value="no">Nie</option>
              </select>
              <div class="small">Toto je presne t√° ‚ÄúSpolu‚Äù riadkov√° matematika v spodnej tabuƒæke DP.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
</template>

<template id="tplOrSep">
  <div class="or-sep" data-or-sep>A L E B O</div>
</template>

<template id="tplItem">
  <div class="item" data-item>
    <div class="item-head">
      <div class="left">Polo≈æka v tejto sekcii</div>
      <div class="right">
        <button class="btn ghost" type="button" data-add-or>+ ALEBO</button>
        <button class="icon-btn danger" type="button" title="Odstr√°ni≈• polo≈æku" data-del-item>üóëÔ∏è</button>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Typ produktu (voƒæn√Ω text)</label>
        <input data-type class="important" list="dlTypes" placeholder="napr. B1 plag√°t">
      </div>
      <div>
        <label>≈†pecifik√°cia (rozmer)</label>
        <input data-dim placeholder="‚Äî">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>N√°zov polo≈æky</label>
        <input data-title placeholder="napr. B1 plag√°t">
      </div>
      <div>
        <label>Doplnenie / pozn√°mka (riadok pod n√°zvom)</label>
        <input data-note placeholder="">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>Cenov√Ω re≈æim</label>
        <select data-price-mode class="important">
          <option value="unit" selected>Cena za kus √ó poƒçet</option>
          <option value="fixed">Fixn√° cena spolu</option>
        </select>
      </div>
      <div>
        <label>Poƒçet</label>
        <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap:10px;">
          <select data-qtymode class="important" title="Re≈æim poƒçtu">
            <option value="exact" selected>Presn√Ω</option>
            <option value="max">Max</option>
          </select>
          <input data-qty type="number" min="0" step="1" value="1" class="important">
        </div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;" data-unit-wrap>
      <div>
        <label>Cena</label>
        <input data-price type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div>
        <label>Zv√Ωhodnen√° cena</label>
        <input data-discount type="number" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px; display:none;" data-fixed-wrap>
      <div>
        <label>Fixn√° cena spolu</label>
        <input data-fixed-total type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div></div>
    </div>

    <div class="item-foot">
      <div style="min-width:260px;">
        <label>Obdobie pod cenou</label>
        <input data-period placeholder="" value="cena za 3 mesiace">
      </div>

      <div class="price-block">
        <div class="price-old" data-old></div>
        <div class="price-main" data-total>0,00 ‚Ç¨</div>
        <div class="price-period">(v√Ωpoƒçet podƒæa zvolen√©ho re≈æimu)</div>
      </div>
    </div>

    <div class="preview-row img-controls">
      <div>
        <label>Obr√°zok (voliteƒæn√©)</label>
        <input data-img type="file" accept="image/*">
      </div>
      <div class="thumb" data-thumb>
        <span class="small">bez obr√°zka</span>
      </div>
    </div>

    <div class="note-box">
      <label>Vlastn√° pozn√°mka pod polo≈ækou (voliteƒæn√©)</label>
      <!-- √öMYSELNE pr√°zdny placeholder (podƒæa tvojej po≈æiadavky) -->
      <textarea data-extra></textarea>
    </div>
  </div>
</template>

<template id="tplDpSpot">
  <div class="dp-row" data-dp-spot>
    <div>
      <label>Sekundy</label>
      <input data-dp-sec type="number" min="1" step="1" class="important" value="15">
    </div>
    <div>
      <label>Be≈æn√° cena</label>
      <input data-dp-price type="number" min="0" step="0.01" placeholder="0.00">
    </div>
    <div>
      <label>Zv√Ωhodnen√° cena</label>
      <input data-dp-disc type="number" min="0" step="0.01" placeholder="0.00">
    </div>
    <div>
      <label>Popis (napr. Janu√°r 2026)</label>
      <input data-dp-label placeholder="">
    </div>
    <div class="dp-actions">
      <button class="icon-btn danger" type="button" title="Odstr√°ni≈• spot" data-dp-del-spot>üóëÔ∏è</button>
    </div>
  </div>
</template>

<template id="tplDpSpec">
  <div class="dp-spec" data-dp-spec>
    <div class="dp-spec-head">
      <div style="flex:1; min-width:280px;">
        <label>≈†pecializ√°cia</label>
        <input data-dp-spec-name class="important" list="dlSpec" placeholder="napr. Pediater" value="Pediater">
      </div>

      <div style="display:flex; gap:10px; align-items:end; flex-wrap:wrap;">
        <div class="img-controls" style="min-width:300px;">
          <label>Fotografia k DP (voliteƒæn√©)</label>
          <input data-dp-spec-img type="file" accept="image/*">
          <div class="small">T√°to fotka p√¥jde do ƒæav√©ho stƒ∫pca v PDF.</div>
        </div>

        <div class="thumb img-controls" data-dp-spec-thumb style="width:120px; height:90px;">
          <span class="small">bez obr√°zka</span>
        </div>

        <button class="icon-btn danger" type="button" title="Odstr√°ni≈• ≈°pecializ√°ciu" data-dp-del-spec>üóëÔ∏è</button>
      </div>
    </div>

    <div class="dp-months" data-dp-months></div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;">
      <button class="btn secondary" type="button" data-dp-add-month>+ Prida≈• mesiac</button>
      <button class="btn ghost" type="button" data-dp-copy-panels>‚Üî Rovnak√Ω poƒçet panelov do v≈°etk√Ωch mesiacov</button>
    </div>
  </div>
</template>

<template id="tplDpMonth">
  <div class="dp-month" data-dp-month>
    <div class="dp-month-grid">
      <div>
        <label>Term√≠n (mesiac)</label>
        <input data-dp-month-name class="important" list="dlMonths" placeholder="napr. Apr√≠l" value="Apr√≠l">
      </div>
      <div>
        <label>Poƒçet panelov</label>
        <input data-dp-panels type="number" min="0" step="1" class="important" value="100">
      </div>
      <div style="display:flex; align-items:end; justify-content:flex-end;">
        <button class="icon-btn danger" type="button" title="Odstr√°ni≈• mesiac" data-dp-del-month>üóëÔ∏è</button>
      </div>
    </div>
  </div>
</template>

<script>
/* ===============================
   UTIL
================================ */
const moneyFmt = new Intl.NumberFormat('sk-SK', { style:'currency', currency:'EUR' });
function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
function formatMoney(val){ return moneyFmt.format(val); }
function normalize(s){ return (s || '').trim().toLowerCase(); }

function nowStamp(){
  const d = new Date();
  const pad = (x)=> String(x).padStart(2,'0');
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return { date:`${yyyy}-${mm}-${dd}`, time:`${hh}:${mi}`, full:`${yyyy}-${mm}-${dd} ${hh}:${mi}` };
}

/* ===============================
   PRESETS
================================ */
function presetFromType(rawType){
  const t = normalize(rawType);

  if(t === 'a3 plag√°t' || t === 'a3 plakat'){
    return { dim:'42 √ó 29,7 cm', title:'A3 plag√°t', period:'cena za 3 mesiace' };
  }
  if(t === 'b1 plag√°t' || t === 'b1 plakat' || t === 'b1'){
    return { dim:'70 √ó 100 cm', title:'B1 plag√°t', period:'cena za 3 mesiace' };
  }
  if(t === 'statick√Ω plag√°t' || t === 'staticky plakat'){
    return { dim:'42 √ó 29,7 cm', title:'Statick√Ω plag√°t', period:'cena za jednu n√°v≈°tevu' };
  }
  if(t === 'tlaƒç materi√°lov' || t === 'tlac materialov'){
    return { dim:'', title:'Tlaƒç materi√°lov', period:'', suggestMode:'fixed' };
  }
  return { dim:'', title:rawType || '', period:'cena za 3 mesiace' };
}

/* ===============================
   DOM
================================ */
const appRoot = document.getElementById('appRoot');
const sectionsWrap = document.getElementById('sections');
const tplSection = document.getElementById('tplSection');
const tplItem = document.getElementById('tplItem');
const tplOrSep = document.getElementById('tplOrSep');
const tplDpSpot = document.getElementById('tplDpSpot');
const tplDpSpec = document.getElementById('tplDpSpec');
const tplDpMonth = document.getElementById('tplDpMonth');

const pdfImagesSel = document.getElementById('pdfImages');
const pdfShowGrandSel = document.getElementById('pdfShowGrand');

/* ===============================
   UI IMAGES ON/OFF
================================ */
function applyImagesSetting(){
  const mode = pdfImagesSel.value;
  if(mode === 'without') appRoot.classList.add('images-off');
  else appRoot.classList.remove('images-off');
}
pdfImagesSel.addEventListener('change', applyImagesSetting);

/* ===============================
   IMAGE HELPERS
================================ */
function setThumbBox(thumbEl, dataUrl){
  thumbEl.innerHTML = '';
  if(!dataUrl){
    thumbEl.innerHTML = '<span class="small">bez obr√°zka</span>';
    return;
  }
  const img = document.createElement('img');
  img.src = dataUrl;
  thumbEl.appendChild(img);
}

/* ===============================
   STANDARD ITEM LOGIC
================================ */
function setItemThumb(itemEl, dataUrl){
  const thumb = itemEl.querySelector('[data-thumb]');
  setThumbBox(thumb, dataUrl);
  itemEl.dataset.img = dataUrl || '';
}
function getItemGroupId(itemEl){ return itemEl.dataset.orGroup || ''; }

function togglePriceMode(itemEl){
  const mode = itemEl.querySelector('[data-price-mode]').value;
  const unitWrap = itemEl.querySelector('[data-unit-wrap]');
  const fixedWrap = itemEl.querySelector('[data-fixed-wrap]');
  if(mode === 'fixed'){
    unitWrap.style.display = 'none';
    fixedWrap.style.display = 'grid';
  } else {
    unitWrap.style.display = 'grid';
    fixedWrap.style.display = 'none';
  }
  recalcItem(itemEl);
}

function recalcItem(itemEl){
  const priceMode = itemEl.querySelector('[data-price-mode]').value;
  const qtyMode = itemEl.querySelector('[data-qtymode]').value;

  const qty = n(itemEl.querySelector('[data-qty]').value);
  const unitPrice = n(itemEl.querySelector('[data-price]').value);
  const disc = n(itemEl.querySelector('[data-discount]').value);
  const fixedTotal = n(itemEl.querySelector('[data-fixed-total]').value);

  let total = 0;
  let oldText = '';

  if(priceMode === 'fixed'){
    total = fixedTotal;
    oldText = '';
  } else {
    const unit = disc > 0 ? disc : unitPrice;
    total = unit * qty;
    if(disc > 0 && unitPrice > 0) oldText = formatMoney(unitPrice);
  }

  itemEl.querySelector('[data-old]').textContent = oldText;

  const shown = (qtyMode === 'max') ? ('max. ' + formatMoney(total)) : formatMoney(total);
  itemEl.querySelector('[data-total]').textContent = shown;
}

function applyPreset(itemEl){
  const typeEl = itemEl.querySelector('[data-type]');
  const dimEl = itemEl.querySelector('[data-dim]');
  const titleEl = itemEl.querySelector('[data-title]');
  const periodEl = itemEl.querySelector('[data-period]');
  const modeEl = itemEl.querySelector('[data-price-mode]');

  const p = presetFromType(typeEl.value);

  if(p.dim) dimEl.value = p.dim;
  if(!titleEl.value && p.title) titleEl.value = p.title;

  const curPer = (periodEl.value ?? '').trim();
  const defaults = new Set(['cena za 3 mesiace','cena za jednu n√°v≈°tevu','']);
  if(curPer === '' || defaults.has(curPer)){
    periodEl.value = p.period ?? 'cena za 3 mesiace';
  }

  if(p.suggestMode === 'fixed'){
    modeEl.value = 'fixed';
    togglePriceMode(itemEl);
  }
}

function wireItem(itemEl){
  const typeInput = itemEl.querySelector('[data-type]');
  const imgInput = itemEl.querySelector('[data-img]');

  if((itemEl.querySelector('[data-period]').value || '').trim() === ''){
    itemEl.querySelector('[data-period]').value = 'cena za 3 mesiace';
  }

  typeInput.addEventListener('change', () => { applyPreset(itemEl); recalcItem(itemEl); });
  typeInput.addEventListener('blur', () => { applyPreset(itemEl); recalcItem(itemEl); });

  itemEl.querySelector('[data-price-mode]').addEventListener('change', () => togglePriceMode(itemEl));

  itemEl.querySelectorAll('input, select, textarea').forEach(el => {
    if(el.matches('[data-img]')) return;
    el.addEventListener('input', () => recalcItem(itemEl));
    el.addEventListener('change', () => recalcItem(itemEl));
  });

  imgInput.addEventListener('change', () => {
    const f = imgInput.files && imgInput.files[0];
    if(!f){ setItemThumb(itemEl, ''); return; }
    const reader = new FileReader();
    reader.onload = () => setItemThumb(itemEl, String(reader.result || ''));
    reader.readAsDataURL(f);
  });

  itemEl.querySelector('[data-del-item]').addEventListener('click', () => {
    const prev = itemEl.previousElementSibling;
    const next = itemEl.nextElementSibling;
    const grp = getItemGroupId(itemEl);

    itemEl.remove();

    if(prev && prev.matches('[data-or-sep]')){
      const after = prev.nextElementSibling;
      if(!after || !after.matches('[data-item]') || getItemGroupId(after) !== grp){
        prev.remove();
      }
    }
    if(next && next.matches('[data-or-sep]')){
      const after = next.nextElementSibling;
      if(!after || !after.matches('[data-item]')){
        next.remove();
      }
    }
  });

  itemEl.querySelector('[data-add-or]').addEventListener('click', () => {
    const itemsWrap = itemEl.parentElement;
    const groupId = getItemGroupId(itemEl) || ('g' + Math.random().toString(16).slice(2));
    itemEl.dataset.orGroup = groupId;

    const maybeNext = itemEl.nextElementSibling;
    if(!(maybeNext && maybeNext.matches('[data-or-sep]'))){
      const sepNode = tplOrSep.content.cloneNode(true);
      itemsWrap.insertBefore(sepNode, itemEl.nextElementSibling);
    }

    const newNode = tplItem.content.cloneNode(true);
    itemsWrap.insertBefore(newNode, itemEl.nextElementSibling.nextElementSibling);

    const newItemEl = itemEl.nextElementSibling.nextElementSibling;
    newItemEl.dataset.orGroup = groupId;

    wireItem(newItemEl);

    newItemEl.querySelector('[data-type]').value = itemEl.querySelector('[data-type]').value;
    newItemEl.querySelector('[data-dim]').value = itemEl.querySelector('[data-dim]').value;
    newItemEl.querySelector('[data-title]').value = itemEl.querySelector('[data-title]').value;
    newItemEl.querySelector('[data-note]').value = itemEl.querySelector('[data-note]').value;
    newItemEl.querySelector('[data-period]').value = itemEl.querySelector('[data-period]').value;

    newItemEl.querySelector('[data-qty]').value = '';
    newItemEl.querySelector('[data-price]').value = '';
    newItemEl.querySelector('[data-discount]').value = '';
    newItemEl.querySelector('[data-fixed-total]').value = '';
    recalcItem(newItemEl);
  });

  setItemThumb(itemEl, '');
  togglePriceMode(itemEl);
  recalcItem(itemEl);
}

function addItem(itemsWrap){
  const node = tplItem.content.cloneNode(true);
  itemsWrap.appendChild(node);
  const itemEl = itemsWrap.lastElementChild;
  wireItem(itemEl);
  return itemEl;
}

/* ===============================
   DIGITAL PANEL (EDIT UI)
================================ */
function addDpSpot(secEl){
  const spotsWrap = secEl.querySelector('[data-dp-spots]');
  const node = tplDpSpot.content.cloneNode(true);
  spotsWrap.appendChild(node);
  const spotEl = spotsWrap.lastElementChild;

  spotEl.querySelector('[data-dp-del-spot]').addEventListener('click', ()=> spotEl.remove());
  return spotEl;
}

function addDpMonth(specEl){
  const monthsWrap = specEl.querySelector('[data-dp-months]');
  const node = tplDpMonth.content.cloneNode(true);
  monthsWrap.appendChild(node);
  const mEl = monthsWrap.lastElementChild;
  mEl.querySelector('[data-dp-del-month]').addEventListener('click', ()=> mEl.remove());
  return mEl;
}

function addDpSpec(secEl){
  const specsWrap = secEl.querySelector('[data-dp-specs]');
  const node = tplDpSpec.content.cloneNode(true);
  specsWrap.appendChild(node);
  const specEl = specsWrap.lastElementChild;

  // image for spec (THIS IS WHAT YOU MISSED)
  const imgInput = specEl.querySelector('[data-dp-spec-img]');
  const thumb = specEl.querySelector('[data-dp-spec-thumb]');
  specEl.dataset.img = '';

  imgInput.addEventListener('change', ()=>{
    const f = imgInput.files && imgInput.files[0];
    if(!f){ specEl.dataset.img=''; setThumbBox(thumb,''); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      const dataUrl = String(reader.result || '');
      specEl.dataset.img = dataUrl;
      setThumbBox(thumb, dataUrl);
    };
    reader.readAsDataURL(f);
  });

  specEl.querySelector('[data-dp-del-spec]').addEventListener('click', ()=> specEl.remove());
  specEl.querySelector('[data-dp-add-month]').addEventListener('click', ()=> addDpMonth(specEl));

  specEl.querySelector('[data-dp-copy-panels]').addEventListener('click', ()=>{
    const first = specEl.querySelector('[data-dp-panels]');
    if(!first) return;
    const val = first.value;
    specEl.querySelectorAll('[data-dp-panels]').forEach(inp => inp.value = val);
  });

  // init 3 months by default
  addDpMonth(specEl);
  addDpMonth(specEl);
  addDpMonth(specEl);

  return specEl;
}

/* ===============================
   SECTION LOGIC
================================ */
function wireSection(secEl){
  const kindSel = secEl.querySelector('[data-sec-kind]');
  const standardWrap = secEl.querySelector('[data-standard]');
  const dpWrap = secEl.querySelector('[data-dp]');

  const itemsWrap = secEl.querySelector('[data-items]');
  secEl.querySelector('[data-del-section]').addEventListener('click', ()=> secEl.remove());
  secEl.querySelector('[data-add-item]').addEventListener('click', ()=> addItem(itemsWrap));

  // DP buttons
  secEl.querySelector('[data-dp-add-spot]').addEventListener('click', ()=> addDpSpot(secEl));
  secEl.querySelector('[data-dp-add-spec]').addEventListener('click', ()=> addDpSpec(secEl));

  function applyKind(){
    const kind = kindSel.value;
    if(kind === 'dp'){
      standardWrap.style.display = 'none';
      dpWrap.style.display = 'block';
      // auto n√°zov
      const nameInp = secEl.querySelector('[data-sec-name]');
      if(!nameInp.value.trim()) nameInp.value = 'Digit√°lny panel v ƒçak√°rni lek√°ra';
      // init DP content if empty
      const spotsWrap = secEl.querySelector('[data-dp-spots]');
      if(spotsWrap.children.length === 0){
        const s1 = addDpSpot(secEl); s1.querySelector('[data-dp-sec]').value = 15;
        const s2 = addDpSpot(secEl); s2.querySelector('[data-dp-sec]').value = 20;
        const s3 = addDpSpot(secEl); s3.querySelector('[data-dp-sec]').value = 30;
      }
      const specsWrap = secEl.querySelector('[data-dp-specs]');
      if(specsWrap.children.length === 0){
        const a = addDpSpec(secEl); a.querySelector('[data-dp-spec-name]').value='Praktick√Ω lek√°r';
        const b = addDpSpec(secEl); b.querySelector('[data-dp-spec-name]').value='Pediater';
        const c = addDpSpec(secEl); c.querySelector('[data-dp-spec-name]').value='Gynekol√≥g';
      }
    } else {
      dpWrap.style.display = 'none';
      standardWrap.style.display = 'block';
      if(itemsWrap.children.length === 0) addItem(itemsWrap);
    }
  }
  kindSel.addEventListener('change', applyKind);
  applyKind();

  // default 1 item for standard
  if(itemsWrap.children.length === 0) addItem(itemsWrap);
}

function addSection(){
  const node = tplSection.content.cloneNode(true);
  sectionsWrap.appendChild(node);
  const secEl = sectionsWrap.lastElementChild;
  wireSection(secEl);
}

/* ===============================
   PDF COLLECT
================================ */
function collectState(){
  const title = document.getElementById('offerTitle').value.trim() || 'Cenov√° ponuka';
  const subtitle = document.getElementById('offerSubtitle').value.trim();
  const fileName = document.getElementById('fileName').value.trim();

  const imagesMode = document.getElementById('pdfImages').value; // with/without
  const showGrand = document.getElementById('pdfShowGrand').value === 'yes';

  const sections = [];
  sectionsWrap.querySelectorAll('[data-section]').forEach(secEl => {
    const secName = secEl.querySelector('[data-sec-name]').value.trim();
    const secPeriod = secEl.querySelector('[data-sec-period]').value.trim();
    const kind = secEl.querySelector('[data-sec-kind]').value;

    if(kind === 'dp'){
      const dpTitle = secEl.querySelector('[data-dp-title]').value.trim() || 'Spot v digit√°lnom paneli';
      const dpUnit = secEl.querySelector('[data-dp-unit]').value.trim() || 'Cena / 1 panel / mesiac';
      const dpNote = (secEl.querySelector('[data-dp-note]').value || '').trim();
      const dpShowTotals = secEl.querySelector('[data-dp-show-totals]').value === 'yes';

      const spots = [];
      secEl.querySelectorAll('[data-dp-spot]').forEach(s => {
        spots.push({
          sec: n(s.querySelector('[data-dp-sec]').value),
          price: n(s.querySelector('[data-dp-price]').value),
          disc: n(s.querySelector('[data-dp-disc]').value),
          label: (s.querySelector('[data-dp-label]').value || '').trim()
        });
      });

      const specs = [];
      secEl.querySelectorAll('[data-dp-spec]').forEach(sp => {
        const specName = (sp.querySelector('[data-dp-spec-name]').value || '').trim();
        const img = (imagesMode === 'with') ? (sp.dataset.img || '') : '';

        const months = [];
        sp.querySelectorAll('[data-dp-month]').forEach(m => {
          months.push({
            month: (m.querySelector('[data-dp-month-name]').value || '').trim(),
            panels: n(m.querySelector('[data-dp-panels]').value)
          });
        });

        specs.push({ specName, img, months });
      });

      sections.push({ kind, secName, secPeriod, dpTitle, dpUnit, spots, specs, dpNote, dpShowTotals });
      return;
    }

    // STANDARD
    const items = [];
    const container = secEl.querySelector('[data-items]');
    Array.from(container.children).forEach(child => {
      if(child.matches && child.matches('[data-or-sep]')){ items.push({ __or:true }); return; }
      if(!(child.matches && child.matches('[data-item]'))) return;

      const type = child.querySelector('[data-type]').value.trim();
      const dim = child.querySelector('[data-dim]').value.trim();
      const title = child.querySelector('[data-title]').value.trim();
      const note = child.querySelector('[data-note]').value.trim();
      const extra = child.querySelector('[data-extra]').value.trim();
      const period = (child.querySelector('[data-period]').value || '').trim();

      const priceMode = child.querySelector('[data-price-mode]').value;
      const qtyMode = child.querySelector('[data-qtymode]').value;
      const qty = n(child.querySelector('[data-qty]').value);

      const price = n(child.querySelector('[data-price]').value);
      const discount = n(child.querySelector('[data-discount]').value);
      const fixedTotal = n(child.querySelector('[data-fixed-total]').value);

      let total = 0;
      if(priceMode === 'fixed'){
        total = fixedTotal;
      } else {
        const unit = (discount > 0) ? discount : price;
        total = unit * qty;
      }

      const img = (imagesMode === 'with') ? (child.dataset.img || '') : '';

      items.push({ type, dim, title, note, extra, period, priceMode, qtyMode, qty, price, discount, fixedTotal, total, img });
    });

    sections.push({ kind:'standard', secName, secPeriod, items });
  });

  return { title, subtitle, fileName, imagesMode, showGrand, sections };
}

/* ===============================
   PDF RENDER
================================ */
function renderPDF(){
  const state = collectState();
  const stamp = nowStamp();

  document.getElementById('pvTitle').textContent = state.title;
  document.getElementById('pvSubtitle').textContent = state.subtitle;
  document.getElementById('pvGenerated').textContent = 'Generovan√©: ' + stamp.full;

  const printPage = document.getElementById('printPage');
  if(state.imagesMode === 'without') printPage.classList.add('pv-no-images');
  else printPage.classList.remove('pv-no-images');

  // logo show/hide
  const pvLogo = document.getElementById('pvLogo');
  pvLogo.onerror = () => { pvLogo.style.display = 'none'; };
  pvLogo.style.display = 'block';

  // feel logo (case sensitive)
  const pvFeel = document.getElementById('pvFeel');
  pvFeel.onerror = () => { pvFeel.style.display = 'none'; };
  pvFeel.style.display = 'block';

  // gutter images
  const pvGutter = document.getElementById('pvGutter');
  pvGutter.innerHTML = '';
  if(state.imagesMode === 'with'){
    state.sections.forEach(s => {
      if(s.kind === 'standard'){
        s.items.forEach(it => {
          if(it.__or) return;
          if(!it.img) return;
          const box = document.createElement('div');
          box.className = 'pv-img';
          const img = document.createElement('img');
          img.src = it.img;
          box.appendChild(img);
          pvGutter.appendChild(box);
        });
      } else if(s.kind === 'dp'){
        s.specs.forEach(sp => {
          if(!sp.img) return;
          const box = document.createElement('div');
          box.className = 'pv-img';
          const img = document.createElement('img');
          img.src = sp.img;
          box.appendChild(img);
          pvGutter.appendChild(box);
        });
      }
    });
  }

  const pvSections = document.getElementById('pvSections');
  pvSections.innerHTML = '';

  let grandTotal = 0;

  state.sections.forEach(s => {
    const secDiv = document.createElement('div');
    secDiv.className = 'pv-section';

    const name = document.createElement('div');
    name.className = 'pv-section-name';
    name.textContent = s.secName || '';
    secDiv.appendChild(name);

    const per = document.createElement('div');
    per.className = 'pv-section-period';
    per.textContent = s.secPeriod || '';
    secDiv.appendChild(per);

    if(s.kind === 'dp'){
      // TOP TABLE (spots)
      const titleLine = document.createElement('div');
      titleLine.style.marginTop = '6mm';
      titleLine.style.fontWeight = '800';
      titleLine.textContent = s.secName || 'Digit√°lny panel';
      // POZOR: u≈æ neprid√°vame duplicitn√Ω n√°zov (toto je ten fix)
      // secDiv.appendChild(titleLine);  // ak chce≈° √∫plne bez duplicitn√©ho riadku, nech√°me len sekƒçn√∫ hlaviƒçku hore

      const t = document.createElement('table');
      t.className = 'pv-dp-top';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      [
        {txt:'N√°zov', w:'55%'},
        {txt:'Poƒçet sek√∫nd', w:'15%'},
        {txt:s.dpUnit || 'Cena / 1 panel / mesiac', w:'30%'}
      ].forEach(h=>{
        const th = document.createElement('th');
        th.textContent = h.txt;
        th.style.width = h.w;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      t.appendChild(thead);

      const tbody = document.createElement('tbody');

      (s.spots || []).forEach(sp=>{
        const tr = document.createElement('tr');

        const tdN = document.createElement('td');
        tdN.textContent = s.dpTitle || 'Spot v digit√°lnom paneli';
        tr.appendChild(tdN);

        const tdS = document.createElement('td');
        tdS.style.textAlign = 'right';
        tdS.textContent = String(sp.sec || 0);
        tr.appendChild(tdS);

        const tdP = document.createElement('td');
        tdP.className = 'pv-dp-pricecell';

        const hasDisc = sp.disc > 0;
        const hasBase = sp.price > 0;

        if(hasDisc){
          // ak m√° zƒæavu, hore ide be≈æn√°, pod t√Ωm "Zv√Ωhodnen√° cena ..."
          if(hasBase){
            const old = document.createElement('div');
            old.style.textDecoration = 'line-through';
            old.style.color = '#777';
            old.style.fontSize = '10.5px';
            old.textContent = formatMoney(sp.price);
            tdP.appendChild(old);
          }
          const zh = document.createElement('span');
          zh.className = 'pv-dp-zh';
          zh.textContent = 'Zv√Ωhodnen√° cena ' + formatMoney(sp.disc);
          tdP.appendChild(zh);
        } else {
          tdP.textContent = hasBase ? formatMoney(sp.price) : '';
        }

        // voliteƒæn√Ω label (napr. Janu√°r 2026) ‚Äì keƒè je, uk√°≈æeme ho v malom
        if(sp.label){
          const lb = document.createElement('div');
          lb.style.fontSize = '10px';
          lb.style.color = '#777';
          lb.style.marginTop = '2px';
          lb.textContent = sp.label;
          tdP.appendChild(lb);
        }

        tr.appendChild(tdP);
        tbody.appendChild(tr);
      });

      t.appendChild(tbody);
      secDiv.appendChild(t);

      // specs tables
      (s.specs || []).forEach(spec=>{
        const specName = (spec.specName || '').trim();
        if(specName){
          const st = document.createElement('div');
          st.className = 'pv-dp-spec-title';
          st.textContent = specName;
          secDiv.appendChild(st);
        }

        const mt = document.createElement('table');
        mt.className = 'pv-dp-month-table';

        const mthead = document.createElement('thead');
        const mtrh = document.createElement('tr');
        const spotSecs = (s.spots || []).map(x=> n(x.sec)).filter(x=> x>0);

        const visibleSecs = spotSecs.slice(0,3); // max 3 stƒ∫pce ako chce≈°
        const columns = [
          {txt:'Term√≠n', cls:''},
          {txt:'Poƒçet panelov', cls:'r'},
          ...visibleSecs.map(sec=> ({txt:`Cena spolu za ${sec} sekundov√Ω spot`, cls:'r'}))
        ];

        columns.forEach(c=>{
          const th = document.createElement('th');
          th.textContent = c.txt;
          if(c.cls) th.className = c.cls;
          mtrh.appendChild(th);
        });

        mthead.appendChild(mtrh);
        mt.appendChild(mthead);

        const mtbody = document.createElement('tbody');

        let totals = {};
        visibleSecs.forEach(sec=> totals[sec]=0);

        (spec.months || []).forEach(m=>{
          const tr = document.createElement('tr');

          const tdM = document.createElement('td');
          tdM.textContent = m.month || '';
          tr.appendChild(tdM);

          const tdP = document.createElement('td');
          tdP.className = 'r';
          tdP.textContent = String(m.panels || 0);
          tr.appendChild(tdP);

          visibleSecs.forEach(secVal=>{
            const spot = (s.spots || []).find(x=> n(x.sec) === secVal) || {price:0, disc:0};
            const unit = (spot.disc>0) ? spot.disc : spot.price;
            const sum = unit * (m.panels||0);
            totals[secVal] += sum;

            const td = document.createElement('td');
            td.className = 'r';
            td.textContent = formatMoney(sum);
            tr.appendChild(td);
          });

          mtbody.appendChild(tr);
        });

        // totals row (voliteƒæn√© podƒæa v√Ωberu)
        if(s.dpShowTotals){
          const trTot = document.createElement('tr');
          trTot.style.fontWeight = '800';

          const tdLbl = document.createElement('td');
          tdLbl.textContent = 'Spolu';
          trTot.appendChild(tdLbl);

          const tdEmpty = document.createElement('td');
          tdEmpty.className = 'r';
          tdEmpty.textContent = '';
          trTot.appendChild(tdEmpty);

          visibleSecs.forEach(secVal=>{
            const td = document.createElement('td');
            td.className = 'r';
            td.textContent = formatMoney(totals[secVal] || 0);
            trTot.appendChild(td);
          });

          mtbody.appendChild(trTot);
        }

        mt.appendChild(mtbody);
        secDiv.appendChild(mt);
      });

      // note under DP section (NOT at end of page)
      if((s.dpNote || '').trim()){
        const p = document.createElement('div');
        p.style.marginTop = '6mm';
        p.style.fontSize = '11px';
        p.style.lineHeight = '1.35';
        p.textContent = s.dpNote.trim();
        secDiv.appendChild(p);
      }

      const divLine = document.createElement('div');
      divLine.className = 'pv-divider';
      secDiv.appendChild(divLine);

      pvSections.appendChild(secDiv);
      return;
    }

    // STANDARD TABLE
    const table = document.createElement('table');
    table.className = 'pv-table';

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    const headers = [
      { cls:'c-item', txt:'Polo≈æka' },
      { cls:'c-spec', txt:'≈†pecifik√°cia' },
      { cls:'c-qty',  txt:'Poƒçet' },
      { cls:'c-price',txt:'Cena' },
      { cls:'c-disc', txt:'Zv√Ωh. cena' },
      { cls:'c-total',txt:'Cena spolu' }
    ];
    headers.forEach(h => {
      const th = document.createElement('th');
      th.className = h.cls;
      th.textContent = h.txt;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    s.items.forEach(it => {
      if(it.__or){
        const trOr = document.createElement('tr');
        trOr.className = 'pv-or-row';
        const td = document.createElement('td');
        td.colSpan = 6;
        td.textContent = 'ALEBO';
        trOr.appendChild(td);
        tbody.appendChild(trOr);
        return;
      }

      const tr = document.createElement('tr');

      const tdItem = document.createElement('td');
      tdItem.className = 'c-item';

      const t = document.createElement('div');
      t.className = 'pv-item-title';
      t.textContent = it.title || it.type || '‚Äî';
      tdItem.appendChild(t);

      if(it.note){
        const nn = document.createElement('div');
        nn.className = 'pv-item-note';
        nn.textContent = it.note;
        tdItem.appendChild(nn);
      }

      // period under title
      if(it.period){
        const pp = document.createElement('div');
        pp.className = 'pv-item-period';
        pp.textContent = it.period;
        tdItem.appendChild(pp);
      }

      tr.appendChild(tdItem);

      const tdSpec = document.createElement('td');
      tdSpec.className = 'c-spec';
      tdSpec.textContent = it.dim || '';
      tr.appendChild(tdSpec);

      const tdQty = document.createElement('td');
      tdQty.className = 'c-qty';

      if(it.qtyMode === 'max'){
        // max. hore, ƒç√≠slo pod t√Ωm (fix na tvoju pozn√°mku)
        tdQty.innerHTML = `<div style="line-height:1.05;">max.</div><div style="line-height:1.05; font-weight:800;">${it.qty || 0}</div>`;
      } else {
        tdQty.textContent = String(it.qty || 0);
      }
      tr.appendChild(tdQty);

      const tdPrice = document.createElement('td');
      tdPrice.className = 'c-price';

      if(it.priceMode === 'fixed'){
        tdPrice.textContent = it.fixedTotal > 0 ? formatMoney(it.fixedTotal) : '';
      } else {
        tdPrice.textContent = it.price > 0 ? formatMoney(it.price) : '';
      }
      tr.appendChild(tdPrice);

      const tdDisc = document.createElement('td');
      tdDisc.className = 'c-disc';
      if(it.priceMode === 'fixed'){
        tdDisc.textContent = '';
      } else {
        tdDisc.textContent = it.discount > 0 ? formatMoney(it.discount) : '';
      }
      tr.appendChild(tdDisc);

      const tdTotal = document.createElement('td');
      tdTotal.className = 'c-total';
      const strong = document.createElement('strong');
      const shown = it.qtyMode === 'max' ? ('max. ' + formatMoney(it.total)) : formatMoney(it.total);
      strong.textContent = shown;
      tdTotal.appendChild(strong);
      tr.appendChild(tdTotal);

      grandTotal += it.total;
      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    secDiv.appendChild(table);

    // extras at the end of section (not right after item)
    const extras = s.items.filter(x=> !x.__or && (x.extra||'').trim()).map(x=> x.extra.trim());
    if(extras.length){
      const box = document.createElement('div');
      box.style.marginTop = '6mm';
      box.style.fontSize = '11px';
      box.style.lineHeight = '1.35';
      box.innerHTML = extras.map(t=> `<div style="margin-top:2mm;">${t.replaceAll('<','&lt;').replaceAll('>','&gt;')}</div>`).join('');
      secDiv.appendChild(box);
    }

    const divLine = document.createElement('div');
    divLine.className = 'pv-divider';
    secDiv.appendChild(divLine);

    pvSections.appendChild(secDiv);
  });

  const pvGrandWrap = document.getElementById('pvGrandWrap');
  pvGrandWrap.innerHTML = '';
  if(state.showGrand){
    const grand = document.createElement('div');
    grand.style.marginTop = '8mm';
    grand.style.display = 'flex';
    grand.style.justifyContent = 'flex-end';
    const box = document.createElement('div');
    box.style.width = '260px';
    box.style.borderTop = '1px solid #000';
    box.style.paddingTop = '6mm';
    box.style.textAlign = 'right';
    box.innerHTML = `<div style="font-weight:700;">Spolu</div><div style="font-size:16px; font-weight:800; margin-top:2mm;">${formatMoney(grandTotal)}</div>`;
    grand.appendChild(box);
    pvGrandWrap.appendChild(grand);
  }

  // set doc title for PDF filename
  const base = (state.fileName || state.title || 'Cenov√° ponuka').trim().replace(/[\\/:*?"<>|]+/g,'-');
  document.title = `${stamp.date}_${base}`;
}

/* ===============================
   BUTTONS
================================ */
document.getElementById('btnAddSection').addEventListener('click', addSection);
document.getElementById('btnAddSectionBottom').addEventListener('click', addSection);

document.getElementById('btnPrint').addEventListener('click', () => {
  renderPDF();
  setTimeout(() => window.print(), 80);
});

document.getElementById('btnReset').addEventListener('click', () => {
  document.getElementById('offerTitle').value = 'Cenov√° ponuka';
  document.getElementById('offerSubtitle').value = '';
  document.getElementById('fileName').value = '';
  document.getElementById('pdfImages').value = 'with';
  document.getElementById('pdfShowGrand').value = 'no'; // ‚úÖ predvolen√© NIE
  sectionsWrap.innerHTML = '';
  applyImagesSetting();
  addSection();
});

/* ===============================
   INIT
================================ */
applyImagesSetting();
addSection();
</script>

</body>
</html>
