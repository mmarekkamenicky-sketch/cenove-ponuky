<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cenov√° ponuka</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
/* ===============================
   BASE
================================ */
*{ box-sizing:border-box; }
body{
  margin:0;
  font-family:"Onest", system-ui, sans-serif;
  background:#fff;
  color:#000;
}
.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:24px;
}
h1{ margin:0 0 14px 0; font-size:28px; font-weight:800; }

/* ===============================
   BUTTONS
================================ */
.toolbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
  margin:12px 0 16px;
}
.btn{
  border-radius:999px;
  padding:10px 16px;
  border:1px solid #000;
  background:#fff;
  font-weight:800;
  cursor:pointer;
}
.btn.primary{ background:#000; color:#fff; }
.btn.secondary{ background:#f2f2f2; border-color:#d0d0d0; }
.btn.ghost{ background:#fff; border-color:#d0d0d0; }

.hint{ color:#666; font-size:13px; margin-top:4px; }

/* ===============================
   FORM ELEMENTS
================================ */
label{
  font-size:12px;
  text-transform:uppercase;
  letter-spacing:.08em;
  font-weight:800;
  display:block;
  margin-bottom:4px;
  color:#111;
}
input, select, textarea{
  width:100%;
  padding:10px 12px;
  border-radius:12px;
  border:1px solid #ccc;
  font-family:inherit;
  font-size:14px;
  background:#fff;
}
input[type="number"]{ text-align:right; }
textarea{ min-height:70px; resize:vertical; }
.small{ font-size:12px; color:#666; }
.imp{
  border-color:#1e66ff !important;
  box-shadow:0 0 0 3px rgba(30,102,255,.12);
  font-weight:800;
  color:#0b2c87;
}

/* ===============================
   CARDS
================================ */
.card{
  border:1px solid #ddd;
  border-radius:16px;
  padding:16px;
  margin-bottom:16px;
}
.card h2{ margin:0 0 12px 0; font-size:18px; font-weight:800; }

/* ===============================
   GRID HELPERS
================================ */
.grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
.grid-4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:14px; }
@media (max-width: 900px){
  .grid-2,.grid-3,.grid-4{ grid-template-columns:1fr; }
}

/* ===============================
   SECTIONS EDIT
================================ */
.sections{
  display:flex;
  flex-direction:column;
  gap:14px;
}
.section{
  border:2px solid #000;
  border-radius:16px;
  padding:14px;
}
.section-head{
  display:flex;
  gap:10px;
  justify-content:space-between;
  align-items:flex-start;
  flex-wrap:wrap;
  margin-bottom:10px;
  padding-bottom:10px;
  border-bottom:1px dashed #ddd;
}
.section-title{
  display:grid;
  grid-template-columns:1fr 220px;
  gap:12px;
  width:100%;
}
@media (max-width: 900px){
  .section-title{ grid-template-columns:1fr; }
}
.section-actions{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.icon-btn{
  width:40px;
  height:40px;
  border-radius:999px;
  border:1px solid #d0d0d0;
  background:#f2f2f2;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}
.icon-btn.danger{
  border-color:#ff4d4d;
  background:#ffecec;
}
.section-bottom{
  margin-top:12px;
  padding-top:12px;
  border-top:1px dashed #ddd;
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
}

/* ===============================
   STANDARD ITEMS
================================ */
.items{
  display:flex;
  flex-direction:column;
  gap:12px;
  margin-top:12px;
}
.item{
  border:1px solid #ddd;
  border-radius:14px;
  padding:12px;
}
.item-head{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.item-head .left{ font-weight:800; }
.item-head .right{
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
}
.item-foot{
  margin-top:10px;
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
  flex-wrap:wrap;
}
.price-block{
  text-align:right;
  min-width:260px;
}
.price-old{
  font-size:12px;
  color:#777;
  text-decoration:line-through;
  min-height:16px;
}
.price-main{
  font-weight:800;
  font-size:18px;
}
.price-period{
  margin-top:2px;
  font-size:11px;
  color:#777;
}

/* OR separator */
.or-sep{
  text-align:center;
  font-weight:900;
  letter-spacing:.12em;
  color:#111;
  background:#f3f3f3;
  border:1px solid #ddd;
  border-radius:999px;
  padding:8px 10px;
  margin:2px 0;
}

/* Image upload */
.preview-row{
  margin-top:10px;
  display:flex;
  gap:12px;
  align-items:flex-start;
  flex-wrap:wrap;
}
.thumb{
  width:120px;
  height:90px;
  border:1px solid #ddd;
  border-radius:12px;
  overflow:hidden;
  background:#f6f6f6;
  display:flex;
  align-items:center;
  justify-content:center;
}
.thumb img{
  width:100%;
  height:100%;
  object-fit:cover;
  border-radius:10px;
}
.note-box{ margin-top:10px; }
.images-off .img-controls{ display:none !important; }

/* ===============================
   DIGITAL PANEL (EDIT UI)
================================ */
.dp-wrap{ margin-top:10px; }
.dp-top{
  border:1px solid #ddd;
  border-radius:14px;
  padding:12px;
}
.dp-top h3{ margin:0 0 10px 0; font-size:15px; font-weight:800; }
.dp-top-grid{
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:10px;
}
@media (max-width: 900px){
  .dp-top-grid{ grid-template-columns:1fr; }
}
.dp-row{
  border:1px solid #e5e5e5;
  border-radius:12px;
  padding:10px;
}
.dp-row .rhead{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:8px;
}
.dp-row .rhead strong{ font-size:13px; }
.dp-row .rhead .mini{
  display:flex; gap:8px; align-items:center; flex-wrap:wrap;
}
.dp-row .rgrid{
  display:grid;
  grid-template-columns: 120px 1fr 1fr;
  gap:10px;
  align-items:end;
}
.dp-row .rgrid .mid{ text-align:center; }
.dp-row .rgrid input[type="number"]{ text-align:right; }
.dp-row small{ color:#666; }

.dp-specs{
  margin-top:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.dp-spec{
  border:1px solid #ddd;
  border-radius:14px;
  padding:12px;
}
.dp-spec-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.dp-spec-head .left{ flex:1; min-width:260px; }
.dp-spec-head .right{
  display:flex; gap:10px; align-items:center; flex-wrap:wrap;
}
.dp-months{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.dp-month{
  border:1px solid #eee;
  border-radius:12px;
  padding:10px;
}
.dp-month .mgrid{
  display:grid;
  grid-template-columns: 160px 160px 1fr;
  gap:10px;
  align-items:end;
}
@media (max-width: 900px){
  .dp-month .mgrid{ grid-template-columns:1fr; }
}
.dp-month .cols{
  margin-top:10px;
  display:grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap:10px;
}
.dp-month .cols .col{
  border:1px dashed #ddd;
  border-radius:12px;
  padding:10px;
}
.dp-month .cols .col .ctitle{ font-size:12px; font-weight:800; margin-bottom:6px; }
.dp-month .cols .col input{ text-align:right; }
.dp-actions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  flex-wrap:wrap;
  margin-top:10px;
}

/* ===============================
   GLOBAL SETTINGS (end)
================================ */
.end-settings{
  border-top:1px dashed #ddd;
  padding-top:12px;
  margin-top:12px;
}

/* ===============================
   PRINT / PDF VIEW
================================ */
.print-view{ display:none; }

.print-page{
  width:210mm;
  min-height:297mm;
  margin:0 auto;
  background:#fff;
  padding:18mm 14mm 18mm 14mm; /* footer is fixed; keep bottom safe */
  position:relative;
}

/* IDS logo (top-right) */
.pv-logo{
  position:absolute;
  top:10mm;
  right:14mm;
  width:26mm;
  height:auto;
  opacity:0.95;
}

/* left gutter for images */
.pv-gutter{
  position:absolute;
  left:14mm;
  top:18mm;
  bottom:24mm; /* leave space for footer */
  width:42mm;
  display:flex;
  flex-direction:column;
  gap:10mm;
}
.pv-gutter .pv-img{
  width:100%;
  border-radius:3mm;
  overflow:hidden;
  border:1px solid #ddd;
  background:#f6f6f6;
}
.pv-gutter .pv-img img{
  width:100%;
  height:auto;
  display:block;
}

/* content shifted right */
.pv-content{ margin-left:48mm; }

/* header */
.pv-header{ margin-bottom:12mm; }
.pv-title{ font-size:34px; font-weight:800; }
.pv-subtitle{ font-size:16px; margin-top:4px; font-weight:500; }

/* section */
.pv-section{ margin-top:10mm; page-break-inside: avoid; }
.pv-section-name{ font-size:13px; font-weight:800; }
.pv-section-period{ margin-top:2mm; font-size:12px; font-weight:500; color:#111; }

/* table */
.pv-table{
  margin-top:6mm;
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  font-size:11.5px;
}
.pv-table th{
  text-align:left;
  font-size:10px;
  text-transform:uppercase;
  letter-spacing:.08em;
  border-bottom:1px solid #000;
  padding-bottom:6px;
}
.pv-table td{
  padding:8px 0;
  vertical-align:top;
}
.pv-table tr{ page-break-inside: avoid; }

.c-item{ width:44%; }
.c-spec{ width:22%; }
.c-qty{ width:10%; text-align:right; }
.c-price{ width:12%; text-align:right; }
.c-total{ width:12%; text-align:right; }

.pv-item-title{ font-weight:700; }
.pv-item-note{ font-size:10.5px; margin-top:2px; color:#111; }
.pv-item-period{ margin-top:3px; font-size:10px; color:#777; }

.pv-divider{ margin-top:8mm; border-top:1px solid #000; }

.pv-no-images .pv-gutter{ display:none; }
.pv-no-images .pv-content{ margin-left:0; }

/* OR row in PDF */
.pv-or-row td{
  padding:10px 0;
  text-align:center !important;
  font-weight:900;
  letter-spacing:.12em;
  color:#111;
}

/* Discount block in PDF */
.pv-price-old{
  text-decoration:line-through;
  color:#777;
  font-size:10.5px;
}
.pv-price-new{
  font-weight:800;
  color:#000;
  margin-top:2px;
}

/* Notes blocks */
.pv-note-block{
  margin-top:6mm;
  font-size:10.5px;
  color:#111;
  line-height:1.35;
}

/* FOOTER on each page */
.pv-footer{
  position:fixed;
  left:14mm;
  right:14mm;
  bottom:8mm;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10mm;
  font-size:10.5px;
  color:#111;
}
.pv-footer .left{
  display:flex;
  align-items:center;
  gap:8px;
}
.pv-footer img{
  height:12mm;
  width:auto;
}
.pv-footer a{
  color:#111;
  text-decoration:none;
  border-bottom:1px solid rgba(0,0,0,.25);
}
.pv-footer .right{ white-space:nowrap; }

/* print rules */
@media print{
  .wrap{ display:none !important; }
  .print-view{ display:block !important; }
  body{ margin:0; }
  @page{ margin:0; }
}
</style>
</head>

<body>

<div class="wrap" id="appRoot">
  <h1>Cenov√° ponuka ‚Äì formul√°r</h1>

  <div class="toolbar">
    <button class="btn primary" id="btnPrint" type="button">Export do PDF</button>
    <button class="btn secondary" id="btnAddSection" type="button">+ Prida≈• sekciu</button>
    <button class="btn ghost" id="btnReset" type="button">Vymaza≈• (demo)</button>
  </div>
  <div class="hint">Zƒæavy: v PDF sa v≈ædy zobraz√≠ p√¥vodn√° (pre≈°krtnut√°) a pod ≈àou zv√Ωhodnen√° (tuƒçne). Stƒ∫pec ‚ÄûZv√Ωh. cena‚Äú u≈æ nie je.</div>

  <!-- Offer base -->
  <div class="card">
    <h2>Z√°klad ponuky</h2>

    <div class="grid-2">
      <div>
        <label for="offerTitle">N√°zov ponuky</label>
        <input id="offerTitle" value="Cenov√° ponuka">
      </div>
      <div>
        <label for="offerSubtitle">Podnadpis</label>
        <input id="offerSubtitle" placeholder="napr. Digit√°lny panel v ƒçak√°rni pediatra" value="">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label for="fileName">N√°zov s√∫boru (pre PDF)</label>
        <input id="fileName" placeholder="napr. PED123">
        <div class="small">Pred n√°zov sa automaticky prid√° d√°tum (YYYY-MM-DD_).</div>
      </div>
      <div>
        <label for="pdfShowGrand">Zobrazi≈• fin√°lny s√∫ƒçet (Spolu) v PDF?</label>
        <select id="pdfShowGrand" class="imp">
          <option value="no" selected>Nie</option>
          <option value="yes">√Åno</option>
        </select>
        <div class="small">Pozor: toto je len fin√°lny s√∫ƒçet na konci. Riadkov√© ‚Äûcena spolu‚Äú zost√°va v≈ædy.</div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label for="stdNoteOn">Pozn√°mka pod ≈°tandardn√Ωmi plochami (v PDF)</label>
        <select id="stdNoteOn" class="imp">
          <option value="yes" selected>√Åno</option>
          <option value="no">Nie</option>
        </select>
      </div>
      <div>
        <label for="pdfImages">Obr√°zky (ƒæav√Ω stƒ∫pec v PDF)</label>
        <select id="pdfImages" class="imp">
          <option value="with" selected>S obr√°zkami</option>
          <option value="without">Bez obr√°zkov (cel√° ≈°√≠rka)</option>
        </select>
        <div class="small">Tip: Logo IDS = <strong>ids-logo.png</strong>, Feel = <strong>Feel.png</strong> (v rovnakom prieƒçinku).</div>
      </div>
    </div>
  </div>

  <!-- Sections -->
  <div class="card">
    <h2>Sekcie</h2>
    <div class="sections" id="sections"></div>

    <div class="end-settings">
      <div class="grid-2">
        <div class="small">Tip: Digit√°lny panel sekcia m√° vlastn√© tabuƒæky (sekundy + ≈°pecializ√°cie + mesiace).</div>
        <div style="text-align:right;">
          <button class="btn secondary" id="btnAddSectionBottom" type="button">+ Prida≈• sekciu</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRINT VIEW -->
<section class="print-view" id="printView">
  <div class="print-page" id="printPage">
    <!-- IDS logo -->
    <img class="pv-logo" id="pvLogo" src="ids-logo.png" alt="IDS logo" />

    <div class="pv-gutter" id="pvGutter"></div>

    <div class="pv-content">
      <div class="pv-header">
        <div class="pv-title" id="pvTitle">Cenov√° ponuka</div>
        <div class="pv-subtitle" id="pvSubtitle"></div>
      </div>

      <div id="pvSections"></div>
      <div id="pvGrandWrap"></div>

      <!-- Always at the very end -->
      <div class="pv-note-block" style="margin-top:8mm; font-weight:700;">Ceny s√∫ bez DPH.</div>
    </div>

    <!-- Footer -->
    <div class="pv-footer" id="pvFooter">
      <div class="left">
        <img id="pvFeel" src="Feel.png" alt="feel the good network" />
      </div>
      <div class="mid">
        <a href="https://www.ids-media.sk" target="_blank" rel="noopener">www.ids-media.sk</a>
      </div>
      <div class="right" id="pvGenerated">Generovan√©: ‚Äî</div>
    </div>
  </div>
</section>

<!-- DATALISTS -->
<datalist id="dlSectionNames">
  <option value="Komunik√°cia v ƒçak√°rni pediatra"></option>
  <option value="Komunik√°cia v ƒçak√°rni gynekol√≥ga"></option>
  <option value="Komunik√°cia v ƒçak√°rni praktick√©ho lek√°ra"></option>
  <option value="Komunik√°cia v ƒçak√°rni urol√≥ga"></option>
  <option value="Osobn√° n√°v≈°teva lek√°ra"></option>
  <option value="Komunik√°cia v lek√°rni"></option>
  <option value="Komunik√°cia v ƒçak√°rni gastroenterol√≥ga"></option>
</datalist>

<datalist id="dlTypes">
  <option value="A3 plag√°t"></option>
  <option value="B1 plag√°t"></option>
  <option value="Statick√Ω plag√°t"></option>
  <option value="Umiestnenie let√°kov"></option>
  <option value="Odovzdanie materi√°lov"></option>
  <option value="A3 plag√°t s umiestnen√≠m let√°ku pod plag√°tom"></option>
  <option value="B1 plag√°t s umiestnen√≠m let√°ku pod plag√°tom"></option>

  <!-- doplnen√© -->
  <option value="B1 plag√°t s umiesten√≠m let√°ku do u≈°ka pod B1 plag√°t"></option>
  <option value="A3 plag√°t s umiesten√≠m let√°ku pod plag√°tom v stojane IDS"></option>

  <option value="Umiestnenie materi√°lov do ƒçak√°rni praktick√Ωch lek√°rov"></option>
  <option value="Umiestnenie materi√°lov do ƒçak√°rni pediatrov"></option>
  <option value="Umiestnenie materi√°lov do ƒçak√°rni gynekol√≥gov"></option>
  <option value="Umiestnenie statick√©ho plag√°tu v sieti IDS"></option>
  <option value="Umiestnenie statick√©ho plag√°tu mimo siete IDS"></option>
  <option value="Osobne odovzdanie materi√°lov do ambulancii (v sieti IDS)"></option>
  <option value="Osobne odovzdanie materi√°lov do ambulancii (mimo siete IDS)"></option>
  <option value="Tlaƒç materi√°lov"></option>
</datalist>

<!-- TEMPLATES -->
<template id="tplSection">
  <div class="section" data-section>
    <div class="section-head">
      <div class="section-title">
        <div>
          <label>Typ sekcie</label>
          <select data-sec-kind class="imp">
            <option value="standard" selected>≈†tandardn√© plochy</option>
            <option value="digital">Digit√°lny panel</option>
          </select>
          <div class="small">Digit√°lny panel m√° vlastn√Ω v√Ωpoƒçet po mesiacoch.</div>
        </div>

        <div>
          <label>Obdobie (Q)</label>
          <input data-sec-period placeholder="napr. Q2 2025" value="">
        </div>
      </div>

      <div class="section-actions">
        <button class="icon-btn danger" type="button" title="Odstr√°ni≈• sekciu" data-del-section>üóëÔ∏è</button>
      </div>
    </div>

    <!-- Standard header -->
    <div data-standard-head>
      <div class="grid-2" style="margin-top:6px;">
        <div>
          <label>N√°zov sekcie</label>
          <input data-sec-name list="dlSectionNames" placeholder="napr. Komunik√°cia v ƒçak√°rni pediatra" value="">
          <div class="small">M√¥≈æe≈° vybra≈• zo zoznamu alebo nap√≠sa≈• vlastn√Ω n√°zov.</div>
        </div>
        <div>
          <label>‚Äî</label>
          <div class="small" style="margin-top:10px;">Tip: ceny v PDF bud√∫ zarovnan√© pevn√Ωmi ≈°√≠rkami stƒ∫pcov.</div>
        </div>
      </div>
    </div>

    <!-- Digital header -->
    <div data-digital-head style="display:none;">
      <div class="grid-2" style="margin-top:6px;">
        <div>
          <label>N√°zov sekcie</label>
          <input data-dp-name value="Digit√°lny panel v ƒçak√°rni lek√°ra">
          <div class="small">Predvolen√©. M√¥≈æe≈° upravi≈•, ale ≈°tandardne to takto chceme.</div>
        </div>
        <div>
          <label>DP pozn√°mka v PDF?</label>
          <select data-dp-note-on class="imp">
            <option value="yes" selected>√Åno</option>
            <option value="no">Nie</option>
          </select>
        </div>
      </div>

      <div class="dp-wrap">
        <div class="dp-top">
          <h3>Sekund√°≈æe a cena / 1 panel / mesiac</h3>
          <div class="dp-top-grid" data-dp-seconds></div>

          <div class="dp-actions">
            <button class="btn secondary" type="button" data-dp-add-second>+ Prida≈• sekund√°≈æ</button>
          </div>

          <div class="preview-row img-controls" style="margin-top:12px;">
            <div>
              <label>Fotografie (digit√°lne panely)</label>
              <input data-dp-img type="file" accept="image/*" multiple>
              <div class="small">Vyber viac fotiek naraz (p√¥jdu do ƒæav√©ho stƒ∫pca v PDF).</div>
            </div>
            <div class="thumb" data-dp-thumb><span class="small">bez obr√°zka</span></div>
          </div>
        </div>

        <div class="dp-specs" data-dp-specs></div>

        <div class="dp-actions">
          <button class="btn secondary" type="button" data-dp-add-spec>+ Prida≈• ≈°pecializ√°ciu</button>
        </div>
      </div>
    </div>

    <!-- Standard items -->
    <div class="items" data-items></div>

    <!-- + polo≈æka dole (standard) -->
    <div class="section-bottom" data-standard-bottom>
      <button class="btn secondary" type="button" data-add-item>+ Prida≈• polo≈æku</button>
    </div>
  </div>
</template>

<template id="tplOrSep">
  <div class="or-sep" data-or-sep>A L E B O</div>
</template>

<template id="tplItem">
  <div class="item" data-item>
    <div class="item-head">
      <div class="left">Polo≈æka v tejto sekcii</div>
      <div class="right">
        <button class="btn ghost" type="button" data-add-or>+ ALEBO</button>
        <button class="icon-btn danger" type="button" title="Odstr√°ni≈• polo≈æku" data-del-item>üóëÔ∏è</button>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Typ produktu</label>
        <input data-type list="dlTypes" placeholder="napr. B1 plag√°t">
        <div class="small">N√°vrhy s√∫ v zozname, ale m√¥≈æe≈° nap√≠sa≈• ƒçokoƒævek.</div>
      </div>
      <div>
        <label>Rozmer</label>
        <input data-dim placeholder="‚Äî">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>N√°zov polo≈æky</label>
        <input data-title placeholder="napr. B1 plag√°t">
      </div>
      <div>
        <label>Doplnenie / pozn√°mka (riadok pod n√°zvom)</label>
        <input data-note placeholder="napr. + umiestnenie let√°kov do u≈°ka">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>Cenov√Ω re≈æim</label>
        <select data-price-mode class="imp">
          <option value="unit" selected>Cena za kus √ó poƒçet</option>
          <option value="fixed">Fixn√° cena spolu</option>
        </select>
      </div>
      <div>
        <label>Poƒçet</label>
        <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap:10px;">
          <select data-qtymode title="Re≈æim poƒçtu" class="imp">
            <option value="exact" selected>Presn√Ω</option>
            <option value="max">Max</option>
          </select>
          <input data-qty type="number" min="0" step="1" value="1">
        </div>
      </div>
    </div>

    <!-- unit pricing -->
    <div class="grid-2" style="margin-top:12px;" data-unit-wrap>
      <div>
        <label>Cena za kus</label>
        <input data-price type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div>
        <label>Zv√Ωhodnen√° cena za kus (voliteƒæn√©)</label>
        <input data-discount type="number" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>

    <!-- fixed total -->
    <div class="grid-2" style="margin-top:12px; display:none;" data-fixed-wrap>
      <div>
        <label>Fixn√° cena spolu</label>
        <input data-fixed-total type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div></div>
    </div>

    <div class="item-foot">
      <div style="min-width:260px;">
        <label>Obdobie pod n√°zvom</label>
        <input data-period>
      </div>

      <div class="price-block">
        <div class="price-old" data-old></div>
        <div class="price-main" data-total>0,00 ‚Ç¨</div>
        <div class="price-period">(v√Ωpoƒçet podƒæa zvolen√©ho re≈æimu)</div>
      </div>
    </div>

    <div class="preview-row img-controls">
      <div>
        <label>Obr√°zok (voliteƒæn√©)</label>
        <input data-img type="file" accept="image/*">
      </div>

      <div class="thumb" data-thumb>
        <span class="small">bez obr√°zka</span>
      </div>
    </div>

    <div class="note-box">
      <label>Vlastn√° pozn√°mka (voliteƒæn√©)</label>
      <textarea data-extra placeholder=""></textarea>
    </div>
  </div>
</template>

<template id="tplDpSecond">
  <div class="dp-row" data-dp-second>
    <div class="rhead">
      <strong>Sekund√°≈æ</strong>
      <div class="mini">
        <button class="icon-btn danger" type="button" data-dp-del-second title="Odstr√°ni≈•">üóëÔ∏è</button>
      </div>
    </div>
    <div class="rgrid">
      <div>
        <label>Sekundy</label>
        <input data-sec type="number" min="1" step="1" value="15">
      </div>
      <div class="mid">
        <label>Cena</label>
        <input data-price type="number" min="0" step="0.01" placeholder="0.00">
        <small>‚Ç¨/ 1 panel / mesiac</small>
      </div>
      <div>
        <label>Zv√Ωhodnen√°</label>
        <input data-disc type="number" min="0" step="0.01" placeholder="0.00">
        <small>ak je zƒæava</small>
      </div>
    </div>
  </div>
</template>

<template id="tplDpSpec">
  <div class="dp-spec" data-dp-spec>
    <div class="dp-spec-head">
      <div class="left">
        <label>≈†pecializ√°cia</label>
        <input data-name placeholder="napr. Pediater" class="imp">
      </div>
      <div class="right">
        <button class="btn ghost" type="button" data-fill-count>V≈°ade rovnak√Ω poƒçet</button>
        <button class="icon-btn danger" type="button" data-del title="Odstr√°ni≈• ≈°pecializ√°ciu">üóëÔ∏è</button>
      </div>
    </div>

    <div class="dp-months" data-months></div>

    <div class="dp-actions">
      <button class="btn secondary" type="button" data-add-month>+ Prida≈• mesiac</button>
      <label style="display:flex; align-items:center; gap:8px; font-size:12px; text-transform:none; letter-spacing:0; font-weight:800;">
        <input type="checkbox" data-show-sum style="width:auto; transform:scale(1.1);">
        Zobrazi≈• ‚ÄûSpolu‚Äú v PDF (pre t√∫to ≈°pecializ√°ciu)
      </label>
    </div>
  </div>
</template>

<template id="tplDpMonth">
  <div class="dp-month" data-dp-month>
    <div class="mgrid">
      <div>
        <label>Mesiac</label>
        <input data-month placeholder="napr. Apr√≠l">
      </div>
      <div>
        <label>Poƒçet panelov</label>
        <input data-count type="number" min="0" step="1" value="0">
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; align-items:end;">
        <button class="icon-btn danger" type="button" data-del title="Odstr√°ni≈• mesiac">üóëÔ∏è</button>
      </div>
    </div>

    <div class="cols" data-cols></div>
  </div>
</template>

<template id="tplDpMonthCol">
  <div class="col" data-col>
    <div class="ctitle" data-title>‚Äî</div>
    <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap:10px;">
      <div>
        <label>P√¥vodn√°</label>
        <input data-old type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div>
        <label>Zv√Ωhodnen√°</label>
        <input data-new type="number" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>
  </div>
</template>

<script>
/* ===============================
   UTIL
================================ */
const moneyFmt = new Intl.NumberFormat('sk-SK', { style:'currency', currency:'EUR' });
function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
function formatMoney(val){ return moneyFmt.format(val); }
function normalize(s){ return (s || '').trim().toLowerCase(); }

function pad2(x){ return String(x).padStart(2,'0'); }
function nowStamp(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = pad2(d.getMonth()+1);
  const dd = pad2(d.getDate());
  const hh = pad2(d.getHours());
  const mi = pad2(d.getMinutes());
  return { date:`${yyyy}-${mm}-${dd}`, dt:`${dd}.${mm}.${yyyy} ${hh}:${mi}` };
}

/* ===============================
   PRESETS (STANDARD)
================================ */
function presetFromType(rawType){
  const t = normalize(rawType);

  if(t === 'a3 plag√°t' || t === 'a3 plakat'){
    return { dim:'42 √ó 29,7 cm', title:'A3 plag√°t', period:'cena za 3 mesiace' };
  }
  if(t === 'b1 plag√°t' || t === 'b1 plakat' || t === 'b1'){
    return { dim:'70 √ó 100 cm', title:'B1 plag√°t', period:'cena za 3 mesiace' };
  }
  if(t === 'statick√Ω plag√°t' || t === 'staticky plakat'){
    return { dim:'42 √ó 29,7 cm', title:'Statick√Ω plag√°t', period:'cena za jednu n√°v≈°tevu' };
  }

  if(t === 'a3 plag√°t s umiestnen√≠m let√°ku pod plag√°tom' || t === 'a3 plakat s umiestnen√≠m let√°ku pod plag√°tom'){
    return { dim:'42 √ó 29,7 cm', title:'A3 plag√°t s umiestnen√≠m let√°ku pod plag√°tom', period:'cena za 3 mesiace' };
  }
  if(t === 'b1 plag√°t s umiestnen√≠m let√°ku pod plag√°tom' || t === 'b1 plakat s umiestnen√≠m let√°ku pod plag√°tom'){
    return { dim:'70 √ó 100 cm', title:'B1 plag√°t s umiestnen√≠m let√°ku pod plag√°tom', period:'cena za 3 mesiace' };
  }

  if(t === 'b1 plag√°t s umiesten√≠m let√°ku do u≈°ka pod b1 plag√°t'){
    return { dim:'70 √ó 100 cm', title:'B1 plag√°t', period:'cena za 3 mesiace', note:'+ umiestnenie let√°ku do u≈°ka' };
  }
  if(t === 'a3 plag√°t s umiesten√≠m let√°ku pod plag√°tom v stojane ids'){
    return { dim:'42 √ó 29,7 cm', title:'A3 plag√°t', period:'cena za 3 mesiace', note:'+ umiestnenie let√°ku pod plag√°tom v stojane IDS' };
  }

  const oneVisitList = [
    'umiestnenie materi√°lov do ƒçak√°rni praktick√Ωch lek√°rov',
    'umiestnenie materi√°lov do ƒçak√°rni pediatrov',
    'umiestnenie materi√°lov do ƒçak√°rni gynekol√≥gov',
    'umiestnenie statick√©ho plag√°tu v sieti ids',
    'umiestnenie statick√©ho plag√°tu mimo siete ids',
    'osobne odovzdanie materi√°lov do ambulancii (v sieti ids)',
    'osobne odovzdanie materi√°lov do ambulancii (mimo siete ids)',
  ];
  if(oneVisitList.includes(t)){
    return { dim:'', title:rawType || '', period:'cena za jednu n√°v≈°tevu' };
  }

  if(t === 'tlaƒç materi√°lov' || t === 'tlac materialov'){
    return { dim:'', title:'Tlaƒç materi√°lov', period:'', suggestMode:'fixed' };
  }

  return { dim:'', title:rawType || '', period:'cena za 3 mesiace' };
}

/* ===============================
   DOM
================================ */
const appRoot = document.getElementById('appRoot');
const sectionsWrap = document.getElementById('sections');
const tplSection = document.getElementById('tplSection');
const tplItem = document.getElementById('tplItem');
const tplOrSep = document.getElementById('tplOrSep');

const tplDpSecond = document.getElementById('tplDpSecond');
const tplDpSpec = document.getElementById('tplDpSpec');
const tplDpMonth = document.getElementById('tplDpMonth');
const tplDpMonthCol = document.getElementById('tplDpMonthCol');

const pdfImagesSel = document.getElementById('pdfImages');

/* ===============================
   UI IMAGES ON/OFF
================================ */
function applyImagesSetting(){
  const mode = pdfImagesSel.value;
  if(mode === 'without'){
    appRoot.classList.add('images-off');
  } else {
    appRoot.classList.remove('images-off');
  }
}
pdfImagesSel.addEventListener('change', applyImagesSetting);

/* ===============================
   STANDARD ITEM LOGIC
================================ */
function setThumb(itemEl, dataUrl){
  const thumb = itemEl.querySelector('[data-thumb]');
  thumb.innerHTML = '';
  if(!dataUrl){
    thumb.innerHTML = '<span class="small">bez obr√°zka</span>';
    itemEl.dataset.img = '';
    return;
  }
  const img = document.createElement('img');
  img.src = dataUrl;
  thumb.appendChild(img);
  itemEl.dataset.img = dataUrl;
}

function getItemGroupId(itemEl){
  return itemEl.dataset.orGroup || '';
}

function togglePriceMode(itemEl){
  const mode = itemEl.querySelector('[data-price-mode]').value;
  const unitWrap = itemEl.querySelector('[data-unit-wrap]');
  const fixedWrap = itemEl.querySelector('[data-fixed-wrap]');
  if(mode === 'fixed'){
    unitWrap.style.display = 'none';
    fixedWrap.style.display = 'grid';
  } else {
    unitWrap.style.display = 'grid';
    fixedWrap.style.display = 'none';
  }
  recalcItem(itemEl);
}

function recalcItem(itemEl){
  const priceMode = itemEl.querySelector('[data-price-mode]').value;
  const qtyMode = itemEl.querySelector('[data-qtymode]').value;

  const qty = n(itemEl.querySelector('[data-qty]').value);
  const unitPrice = n(itemEl.querySelector('[data-price]').value);
  const disc = n(itemEl.querySelector('[data-discount]').value);
  const fixedTotal = n(itemEl.querySelector('[data-fixed-total]').value);

  let total = 0;
  let oldText = '';

  if(priceMode === 'fixed'){
    total = fixedTotal;
    oldText = '';
  } else {
    const unit = disc > 0 ? disc : unitPrice;
    total = unit * qty;
    if(disc > 0 && unitPrice > 0) oldText = formatMoney(unitPrice);
  }

  itemEl.querySelector('[data-old]').textContent = oldText;

  const shown = (qtyMode === 'max') ? ('max. ' + formatMoney(total)) : formatMoney(total);
  itemEl.querySelector('[data-total]').textContent = shown;
}

function applyPreset(itemEl){
  const typeEl = itemEl.querySelector('[data-type]');
  const dimEl = itemEl.querySelector('[data-dim]');
  const titleEl = itemEl.querySelector('[data-title]');
  const noteEl = itemEl.querySelector('[data-note]');
  const periodEl = itemEl.querySelector('[data-period]');
  const modeEl = itemEl.querySelector('[data-price-mode]');

  const p = presetFromType(typeEl.value);

  if(p.dim) dimEl.value = p.dim;
  if(!titleEl.value && p.title) titleEl.value = p.title;
  if(!noteEl.value && p.note) noteEl.value = p.note;

  const curPer = (periodEl.value ?? '').trim();
  const defaults = new Set(['cena za 3 mesiace','cena za jednu n√°v≈°tevu','']);
  if(curPer === '' || defaults.has(curPer)){
    periodEl.value = p.period ?? 'cena za 3 mesiace';
  }

  if(p.suggestMode === 'fixed'){
    modeEl.value = 'fixed';
    togglePriceMode(itemEl);
  }
}

function wireItem(itemEl){
  const typeInput = itemEl.querySelector('[data-type]');
  const imgInput = itemEl.querySelector('[data-img]');

  if((itemEl.querySelector('[data-period]').value || '').trim() === ''){
    itemEl.querySelector('[data-period]').value = 'cena za 3 mesiace';
  }

  typeInput.addEventListener('change', () => { applyPreset(itemEl); recalcItem(itemEl); });
  typeInput.addEventListener('blur', () => { applyPreset(itemEl); recalcItem(itemEl); });

  itemEl.querySelector('[data-price-mode]').addEventListener('change', () => togglePriceMode(itemEl));

  itemEl.querySelectorAll('input, select, textarea').forEach(el => {
    if(el.matches('[data-img]')) return;
    el.addEventListener('input', () => recalcItem(itemEl));
    el.addEventListener('change', () => recalcItem(itemEl));
  });

  imgInput.addEventListener('change', () => {
    const f = imgInput.files && imgInput.files[0];
    if(!f){ setThumb(itemEl, ''); return; }
    const reader = new FileReader();
    reader.onload = () => setThumb(itemEl, String(reader.result || ''));
    reader.readAsDataURL(f);
  });

  itemEl.querySelector('[data-del-item]').addEventListener('click', () => {
    const prev = itemEl.previousElementSibling;
    const next = itemEl.nextElementSibling;
    const grp = getItemGroupId(itemEl);

    itemEl.remove();

    if(prev && prev.matches('[data-or-sep]')){
      const after = prev.nextElementSibling;
      if(!after || !after.matches('[data-item]') || getItemGroupId(after) !== grp){
        prev.remove();
      }
    }
    if(next && next.matches('[data-or-sep]')){
      const after = next.nextElementSibling;
      if(!after || !after.matches('[data-item]')){
        next.remove();
      }
    }
  });

  itemEl.querySelector('[data-add-or]').addEventListener('click', () => {
    const itemsWrap = itemEl.parentElement;
    const groupId = getItemGroupId(itemEl) || ('g' + Math.random().toString(16).slice(2));
    itemEl.dataset.orGroup = groupId;

    const maybeNext = itemEl.nextElementSibling;
    if(!(maybeNext && maybeNext.matches('[data-or-sep]'))){
      const sepNode = tplOrSep.content.cloneNode(true);
      itemsWrap.insertBefore(sepNode, itemEl.nextElementSibling);
    }

    const newNode = tplItem.content.cloneNode(true);
    const temp = document.createElement('div');
    temp.appendChild(newNode);
    const newItemEl = temp.firstElementChild;

    newItemEl.dataset.orGroup = groupId;

    const sepEl = itemEl.nextElementSibling;
    itemsWrap.insertBefore(newItemEl, sepEl.nextElementSibling);

    wireItem(newItemEl);

    newItemEl.querySelector('[data-type]').value = itemEl.querySelector('[data-type]').value;
    newItemEl.querySelector('[data-dim]').value = itemEl.querySelector('[data-dim]').value;
    newItemEl.querySelector('[data-title]').value = itemEl.querySelector('[data-title]').value;
    newItemEl.querySelector('[data-note]').value = itemEl.querySelector('[data-note]').value;
    newItemEl.querySelector('[data-period]').value = itemEl.querySelector('[data-period]').value;

    newItemEl.querySelector('[data-qty]').value = '';
    newItemEl.querySelector('[data-price]').value = '';
    newItemEl.querySelector('[data-discount]').value = '';
    newItemEl.querySelector('[data-fixed-total]').value = '';
    newItemEl.querySelector('[data-extra]').value = '';

    recalcItem(newItemEl);
  });

  setThumb(itemEl, '');
  togglePriceMode(itemEl);
  recalcItem(itemEl);
}

function addItem(itemsWrap){
  const node = tplItem.content.cloneNode(true);
  itemsWrap.appendChild(node);
  const itemEl = itemsWrap.lastElementChild;
  wireItem(itemEl);
  return itemEl;
}

/* ===============================
   DIGITAL PANEL LOGIC
================================ */
function dpSetThumb(secEl, dataUrls){
  const thumb = secEl.querySelector('[data-dp-thumb]');
  thumb.innerHTML = '';
  const arr = Array.isArray(dataUrls) ? dataUrls : [];
  secEl.dataset.dpImgs = JSON.stringify(arr);

  if(arr.length === 0){
    thumb.innerHTML = '<span class="small">bez obr√°zka</span>';
    return;
  }
  const img = document.createElement('img');
  img.src = arr[0];
  thumb.appendChild(img);
}

function dpGetSeconds(secEl){
  const wrap = secEl.querySelector('[data-dp-seconds]');
  const secs = [];
  wrap.querySelectorAll('[data-dp-second]').forEach(r => {
    const s = n(r.querySelector('[data-sec]').value);
    const price = n(r.querySelector('[data-price]').value);
    const disc = n(r.querySelector('[data-disc]').value);
    if(s > 0) secs.push({ s, price, disc });
  });
  // unique by seconds
  const map = new Map();
  secs.forEach(x => { if(!map.has(x.s)) map.set(x.s, x); });
  return Array.from(map.values()).sort((a,b)=>a.s-b.s);
}

function dpRebuildMonthCols(secEl){
  const seconds = dpGetSeconds(secEl);
  const specsWrap = secEl.querySelector('[data-dp-specs]');
  specsWrap.querySelectorAll('[data-dp-spec]').forEach(specEl => {
    specEl.querySelectorAll('[data-dp-month]').forEach(mEl => {
      const cols = mEl.querySelector('[data-cols]');
      cols.innerHTML = '';
      seconds.slice(0,3).forEach(x => {
        const colNode = tplDpMonthCol.content.cloneNode(true);
        const temp = document.createElement('div');
        temp.appendChild(colNode);
        const colEl = temp.firstElementChild;
        colEl.querySelector('[data-title]').textContent = `Cena spolu za ${x.s} sekundov√Ω spot`;
        colEl.dataset.sec = String(x.s);
        cols.appendChild(colEl);
      });
    });
  });
}

function dpAddSecond(secEl, initSec=15){
  const wrap = secEl.querySelector('[data-dp-seconds]');
  const node = tplDpSecond.content.cloneNode(true);
  wrap.appendChild(node);
  const row = wrap.lastElementChild;
  row.querySelector('[data-sec]').value = initSec;

  const onAny = () => dpRebuildMonthCols(secEl);
  row.querySelectorAll('input').forEach(i => i.addEventListener('input', onAny));

  row.querySelector('[data-dp-del-second]').addEventListener('click', () => {
    row.remove();
    dpRebuildMonthCols(secEl);
  });
}

function dpAddMonth(secEl, specEl, monthName=''){
  const monthsWrap = specEl.querySelector('[data-months]');
  const node = tplDpMonth.content.cloneNode(true);
  monthsWrap.appendChild(node);
  const mEl = monthsWrap.lastElementChild;
  mEl.querySelector('[data-month]').value = monthName;

  // delete month
  mEl.querySelector('[data-del]').addEventListener('click', () => mEl.remove());

  // build cols based on seconds
  dpRebuildMonthCols(secEl);
}

function dpAddSpec(secEl, name=''){
  const specsWrap = secEl.querySelector('[data-dp-specs]');
  const node = tplDpSpec.content.cloneNode(true);
  specsWrap.appendChild(node);
  const specEl = specsWrap.lastElementChild;
  specEl.querySelector('[data-name]').value = name;

  specEl.querySelector('[data-del]').addEventListener('click', () => specEl.remove());
  specEl.querySelector('[data-add-month]').addEventListener('click', () => dpAddMonth(secEl, specEl, ''));

  // fill count helper
  specEl.querySelector('[data-fill-count]').addEventListener('click', () => {
    const first = specEl.querySelector('[data-dp-month] [data-count]');
    const v = first ? first.value : '';
    if(v === '') return;
    specEl.querySelectorAll('[data-dp-month] [data-count]').forEach(inp => inp.value = v);
  });

  // init 3 months empty
  dpAddMonth(secEl, specEl, 'Apr√≠l');
  dpAddMonth(secEl, specEl, 'M√°j');
  dpAddMonth(secEl, specEl, 'J√∫n');
}

/* ===============================
   SECTION LOGIC
================================ */
function setSectionKind(secEl, kind){
  const isDigital = kind === 'digital';

  secEl.querySelector('[data-standard-head]').style.display = isDigital ? 'none' : 'block';
  secEl.querySelector('[data-standard-bottom]').style.display = isDigital ? 'none' : 'flex';
  secEl.querySelector('[data-items]').style.display = isDigital ? 'none' : 'flex';

  secEl.querySelector('[data-digital-head]').style.display = isDigital ? 'block' : 'none';

  // If switching to digital: auto name
  if(isDigital){
    const dpName = secEl.querySelector('[data-dp-name]');
    if(!dpName.value.trim()) dpName.value = 'Digit√°lny panel v ƒçak√°rni lek√°ra';
  }
}

function addSection(){
  const node = tplSection.content.cloneNode(true);
  sectionsWrap.appendChild(node);
  const secEl = sectionsWrap.lastElementChild;

  const itemsWrap = secEl.querySelector('[data-items]');

  // delete
  secEl.querySelector('[data-del-section]').addEventListener('click', () => secEl.remove());

  // kind
  const kindSel = secEl.querySelector('[data-sec-kind]');
  kindSel.addEventListener('change', () => setSectionKind(secEl, kindSel.value));

  // standard add item
  secEl.querySelector('[data-add-item]').addEventListener('click', () => addItem(itemsWrap));

  // digital init
  const dpAddSecondBtn = secEl.querySelector('[data-dp-add-second]');
  const dpAddSpecBtn = secEl.querySelector('[data-dp-add-spec]');
  dpAddSecondBtn.addEventListener('click', () => {
    const secs = dpGetSeconds(secEl).map(x=>x.s);
    const next = secs.length ? (secs[secs.length-1] + 5) : 15;
    dpAddSecond(secEl, next);
    dpRebuildMonthCols(secEl);
  });
  dpAddSpecBtn.addEventListener('click', () => dpAddSpec(secEl, ''));

  // DP image upload
  const dpImgInp = secEl.querySelector('[data-dp-img]');
  dpImgInp.addEventListener('change', () => {
    const files = dpImgInp.files ? Array.from(dpImgInp.files) : [];
    if(files.length === 0){ dpSetThumb(secEl, []); return; }
    const readers = files.map(f => new Promise(res => {
      const r = new FileReader();
      r.onload = () => res(String(r.result || ''));
      r.readAsDataURL(f);
    }));
    Promise.all(readers).then(urls => dpSetThumb(secEl, urls));
  });
  dpSetThumb(secEl, []);

  // default standard section state + 1 item
  setSectionKind(secEl, kindSel.value);
  addItem(itemsWrap);

  // preload DP content (so switch is instant)
  const dpSecondsWrap = secEl.querySelector('[data-dp-seconds]');
  dpSecondsWrap.innerHTML = '';
  dpAddSecond(secEl, 15);
  dpAddSecond(secEl, 20);
  dpAddSecond(secEl, 30);
  dpRebuildMonthCols(secEl);

  const dpSpecsWrap = secEl.querySelector('[data-dp-specs]');
  dpSpecsWrap.innerHTML = '';
  dpAddSpec(secEl, 'Praktick√Ω lek√°r');
  dpAddSpec(secEl, 'Pediater');
  dpAddSpec(secEl, 'Gynekol√≥g');
}

/* ===============================
   PDF RENDER
================================ */
function collectState(){
  const title = document.getElementById('offerTitle').value.trim() || 'Cenov√° ponuka';
  const subtitle = document.getElementById('offerSubtitle').value.trim();

  const imagesMode = document.getElementById('pdfImages').value; // with/without
  const showGrand = document.getElementById('pdfShowGrand').value === 'yes';
  const stdNoteOn = document.getElementById('stdNoteOn').value === 'yes';

  const fileName = document.getElementById('fileName').value.trim();

  const sections = [];
  sectionsWrap.querySelectorAll('[data-section]').forEach(secEl => {
    const kind = secEl.querySelector('[data-sec-kind]').value;
    const secPeriod = secEl.querySelector('[data-sec-period]').value.trim();

    if(kind === 'digital'){
      const name = secEl.querySelector('[data-dp-name]').value.trim() || 'Digit√°lny panel v ƒçak√°rni lek√°ra';
      const dpNoteOn = secEl.querySelector('[data-dp-note-on]').value === 'yes';

      const seconds = dpGetSeconds(secEl).slice(0,3);

      const dpImgs = (imagesMode === 'with') ? (() => {
        try{
          const arr = JSON.parse(secEl.dataset.dpImgs || '[]');
          return Array.isArray(arr) ? arr : [];
        }catch(e){ return []; }
      })() : [];

      const specs = [];
      secEl.querySelectorAll('[data-dp-spec]').forEach(specEl => {
        const specName = specEl.querySelector('[data-name]').value.trim();
        const showSum = !!specEl.querySelector('[data-show-sum]').checked;

        const months = [];
        specEl.querySelectorAll('[data-dp-month]').forEach(mEl => {
          const month = mEl.querySelector('[data-month]').value.trim();
          const count = n(mEl.querySelector('[data-count]').value);

          const cols = [];
          mEl.querySelectorAll('[data-col]').forEach(colEl => {
            const sec = n(colEl.dataset.sec);
            const oldV = n(colEl.querySelector('[data-old]').value);
            const newV = n(colEl.querySelector('[data-new]').value);
            cols.push({ sec, oldV, newV });
          });

          months.push({ month, count, cols });
        });

        specs.push({ specName, showSum, months });
      });

      sections.push({
        kind,
        name,
        secPeriod,
        seconds,
        specs,
        dpNoteOn,
        dpImgs
      });

      return;
    }

    // standard
    const secName = secEl.querySelector('[data-sec-name]').value.trim();
    const items = [];
    const container = secEl.querySelector('[data-items]');
    Array.from(container.children).forEach(child => {
      if(child.matches && child.matches('[data-or-sep]')){
        items.push({ __or:true });
        return;
      }
      if(!(child.matches && child.matches('[data-item]'))) return;

      const type = child.querySelector('[data-type]').value.trim();
      const dim = child.querySelector('[data-dim]').value.trim();
      const title = child.querySelector('[data-title]').value.trim();
      const note = child.querySelector('[data-note]').value.trim();
      const extra = child.querySelector('[data-extra]').value.trim();
      const period = (child.querySelector('[data-period]').value || '').trim();

      const priceMode = child.querySelector('[data-price-mode]').value;
      const qtyMode = child.querySelector('[data-qtymode]').value;
      const qty = n(child.querySelector('[data-qty]').value);

      const price = n(child.querySelector('[data-price]').value);
      const discount = n(child.querySelector('[data-discount]').value);
      const fixedTotal = n(child.querySelector('[data-fixed-total]').value);

      let total = 0;
      if(priceMode === 'fixed'){
        total = fixedTotal;
      } else {
        const unit = (discount > 0) ? discount : price;
        total = unit * qty;
      }

      const img = (imagesMode === 'with') ? (child.dataset.img || '') : '';

      items.push({
        type, dim, title, note, extra, period,
        priceMode, qtyMode, qty,
        price, discount, fixedTotal,
        total, img
      });
    });

    sections.push({ kind, secName, secPeriod, items });
  });

  return { title, subtitle, imagesMode, showGrand, stdNoteOn, fileName, sections };
}

function renderPDF(){
  const state = collectState();
  const stamp = nowStamp();

  // document title to help "Save as"
  const baseName = (state.fileName || 'Cenova_ponuka').replace(/[\\/:*?"<>|]+/g,'_');
  document.title = `${stamp.date}_${baseName}`;

  document.getElementById('pvTitle').textContent = state.title;
  document.getElementById('pvSubtitle').textContent = state.subtitle;

  // footer
  document.getElementById('pvGenerated').textContent = `Generovan√©: ${stamp.dt}`;

  // logo error -> hide
  const pvLogo = document.getElementById('pvLogo');
  pvLogo.onerror = () => { pvLogo.style.display = 'none'; };
  pvLogo.style.display = 'block';

  // feel error -> hide
  const pvFeel = document.getElementById('pvFeel');
  pvFeel.onerror = () => { pvFeel.style.display = 'none'; };
  pvFeel.style.display = 'block';

  const printPage = document.getElementById('printPage');
  if(state.imagesMode === 'without'){
    printPage.classList.add('pv-no-images');
  } else {
    printPage.classList.remove('pv-no-images');
  }

  // gutter images
  const pvGutter = document.getElementById('pvGutter');
  pvGutter.innerHTML = '';
  if(state.imagesMode === 'with'){
    state.sections.forEach(s => {
      if(s.kind === 'digital'){
        (s.dpImgs || []).forEach(src => {
          if(!src) return;
          const box = document.createElement('div');
          box.className = 'pv-img';
          const img = document.createElement('img');
          img.src = src;
          box.appendChild(img);
          pvGutter.appendChild(box);
        });
        return;
      }

      s.items.forEach(it => {
        if(it.__or) return;
        if(!it.img) return;
        const box = document.createElement('div');
        box.className = 'pv-img';
        const img = document.createElement('img');
        img.src = it.img;
        box.appendChild(img);
        pvGutter.appendChild(box);
      });
    });
  }

  const pvSections = document.getElementById('pvSections');
  pvSections.innerHTML = '';

  let grandTotal = 0;

  // helper: standard campaign note (once)
  const stdNoteText = `S√∫ƒças≈•ou kampane je kompletn√° fotodokument√°cia pl√¥ch. V pr√≠pade odovzdania z√°sielok je s√∫ƒças≈•ou kampane kompletn√Ω zoznam odovzdan√Ωch z√°sielok.`;

  let renderedAnyStandard = false;
  let insertedStdNote = false;

  state.sections.forEach((s, idx) => {

    // STANDARD
    if(s.kind !== 'digital'){
      renderedAnyStandard = true;

      const secDiv = document.createElement('div');
      secDiv.className = 'pv-section';

      const name = document.createElement('div');
      name.className = 'pv-section-name';
      name.textContent = s.secName || '';
      secDiv.appendChild(name);

      const per = document.createElement('div');
      per.className = 'pv-section-period';
      per.textContent = s.secPeriod || '';
      secDiv.appendChild(per);

      const table = document.createElement('table');
      table.className = 'pv-table';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');

      const headers = [
        { cls:'c-item', txt:'Polo≈æka' },
        { cls:'c-spec', txt:'≈†pecifik√°cia' },
        { cls:'c-qty', txt:'Poƒçet' },
        { cls:'c-price', txt:'Cena' },
        { cls:'c-total', txt:'Cena spolu' }
      ];
      headers.forEach(h => {
        const th = document.createElement('th');
        th.className = h.cls;
        th.textContent = h.txt;
        trh.appendChild(th);
      });
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');

      s.items.forEach(it => {
        if(it.__or){
          const trOr = document.createElement('tr');
          trOr.className = 'pv-or-row';
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'ALEBO';
          trOr.appendChild(td);
          tbody.appendChild(trOr);
          return;
        }

        const tr = document.createElement('tr');

        const tdItem = document.createElement('td');
        tdItem.className = 'c-item';

        const t = document.createElement('div');
        t.className = 'pv-item-title';
        t.textContent = it.title || it.type || '‚Äî';
        tdItem.appendChild(t);

        if(it.note){
          const nn = document.createElement('div');
          nn.className = 'pv-item-note';
          nn.textContent = it.note;
          tdItem.appendChild(nn);
        }
        if(it.period){
          const pp = document.createElement('div');
          pp.className = 'pv-item-period';
          pp.textContent = it.period;
          tdItem.appendChild(pp);
        }

        tr.appendChild(tdItem);

        const tdSpec = document.createElement('td');
        tdSpec.className = 'c-spec';
        tdSpec.textContent = it.dim || '';
        tr.appendChild(tdSpec);

        const tdQty = document.createElement('td');
        tdQty.className = 'c-qty';

        // max formatting: "max." on its own line (prevents merging with neighbor)
        if(it.qtyMode === 'max'){
          tdQty.innerHTML = `<div style="line-height:1.05;">max.</div><div style="font-weight:700; margin-top:2px;">${it.qty || 0}</div>`;
        } else {
          tdQty.textContent = String(it.qty || 0);
        }
        tr.appendChild(tdQty);

        const tdPrice = document.createElement('td');
        tdPrice.className = 'c-price';

        if(it.priceMode === 'fixed'){
          tdPrice.textContent = it.fixedTotal > 0 ? formatMoney(it.fixedTotal) : '';
        } else {
          if(it.discount > 0 && it.price > 0){
            const old = document.createElement('div');
            old.className = 'pv-price-old';
            old.textContent = formatMoney(it.price);
            const nw = document.createElement('div');
            nw.className = 'pv-price-new';
            nw.textContent = formatMoney(it.discount);
            tdPrice.appendChild(old);
            tdPrice.appendChild(nw);
          } else {
            tdPrice.textContent = it.price > 0 ? formatMoney(it.price) : '';
          }
        }
        tr.appendChild(tdPrice);

        const tdTotal = document.createElement('td');
        tdTotal.className = 'c-total';
        const strong = document.createElement('strong');
        const shown = it.qtyMode === 'max' ? ('max. ' + formatMoney(it.total)) : formatMoney(it.total);
        strong.textContent = shown;
        tdTotal.appendChild(strong);
        tr.appendChild(tdTotal);

        grandTotal += it.total;

        tbody.appendChild(tr);
      });

      table.appendChild(tbody);
      secDiv.appendChild(table);

      // extras (move to end of section, not under title)
      const extras = s.items.filter(x => x && !x.__or && (x.extra || '').trim() !== '').map(x => x.extra.trim());
      if(extras.length){
        const b = document.createElement('div');
        b.className = 'pv-note-block';
        b.style.color = '#111';
        b.style.marginTop = '4mm';
        b.innerHTML = extras.map(x => `<div style="margin-top:2mm;">${escapeHtml(x)}</div>`).join('');
        secDiv.appendChild(b);
      }

      const divLine = document.createElement('div');
      divLine.className = 'pv-divider';
      secDiv.appendChild(divLine);

      pvSections.appendChild(secDiv);

      // Insert standard campaign note ONCE: right after last STANDARD section (before first DIGITAL or end)
      const next = state.sections[idx+1];
      const nextIsDigital = next && next.kind === 'digital';
      const isLast = !next;
      if(state.stdNoteOn && !insertedStdNote && renderedAnyStandard && (nextIsDigital || isLast)){
        const note = document.createElement('div');
        note.className = 'pv-note-block';
        note.textContent = stdNoteText;
        pvSections.appendChild(note);

        const line = document.createElement('div');
        line.className = 'pv-divider';
        pvSections.appendChild(line);

        insertedStdNote = true;
      }

      return;
    }

    // DIGITAL PANEL
    const secDiv = document.createElement('div');
    secDiv.className = 'pv-section';

    // IMPORTANT: only one title (fix double title bug)
    const name = document.createElement('div');
    name.className = 'pv-section-name';
    name.textContent = s.name || 'Digit√°lny panel v ƒçak√°rni lek√°ra';
    secDiv.appendChild(name);

    const per = document.createElement('div');
    per.className = 'pv-section-period';
    per.textContent = s.secPeriod || '';
    secDiv.appendChild(per);

    // Top table: seconds and price per panel / month
    const topTable = document.createElement('table');
    topTable.className = 'pv-table';

    const topHead = document.createElement('thead');
    const trh = document.createElement('tr');
    [
      { cls:'c-item', txt:'N√°zov' },
      { cls:'c-qty', txt:'Poƒçet sek√∫nd' },
      { cls:'c-price', txt:'Cena / 1 panel / mesiac' },
      { cls:'c-total', txt:'' }
    ].forEach(h => {
      const th = document.createElement('th');
      th.className = h.cls;
      th.textContent = h.txt;
      trh.appendChild(th);
    });
    topHead.appendChild(trh);
    topTable.appendChild(topHead);

    const topBody = document.createElement('tbody');

    const seconds = (s.seconds || []).slice(0,3);
    seconds.forEach(x => {
      const tr = document.createElement('tr');

      const td1 = document.createElement('td');
      td1.className = 'c-item';
      td1.innerHTML = `<div class="pv-item-title">Spot v digit√°lnom paneli</div>`;
      tr.appendChild(td1);

      const td2 = document.createElement('td');
      td2.className = 'c-qty';
      // center-ish: use inline block and text-align center inside
      td2.innerHTML = `<div style="text-align:center; font-weight:700;">${x.s}</div>`;
      tr.appendChild(td2);

      const td3 = document.createElement('td');
      td3.className = 'c-price';
      if(x.disc > 0 && x.price > 0){
        td3.innerHTML = `<div class="pv-price-old">${formatMoney(x.price)}</div><div class="pv-price-new">${formatMoney(x.disc)}</div>`;
      } else {
        td3.textContent = x.price > 0 ? formatMoney(x.price) : '';
      }
      tr.appendChild(td3);

      const td4 = document.createElement('td');
      td4.className = 'c-total';
      td4.textContent = '';
      tr.appendChild(td4);

      topBody.appendChild(tr);
    });

    topTable.appendChild(topBody);
    secDiv.appendChild(topTable);

    // Specializations tables
    (s.specs || []).forEach(spec => {
      const h = document.createElement('div');
      h.className = 'pv-section-name';
      h.style.marginTop = '6mm';
      h.textContent = spec.specName || '';
      secDiv.appendChild(h);

      const t = document.createElement('table');
      t.className = 'pv-table';

      const thead2 = document.createElement('thead');
      const tr2 = document.createElement('tr');

      const cols = [
        { cls:'c-item', txt:'Term√≠n' },
        { cls:'c-spec', txt:'Poƒçet panelov' }
      ];
      seconds.forEach(x => cols.push({ cls:'c-price', txt:`Cena spolu za ${x.s} sekundov√Ω spot` }));

      cols.forEach(c => {
        const th = document.createElement('th');
        th.className = c.cls;
        th.textContent = c.txt;
        tr2.appendChild(th);
      });

      thead2.appendChild(tr2);
      t.appendChild(thead2);

      const tbody2 = document.createElement('tbody');

      const sums = new Map(); // sec -> sum
      seconds.forEach(x => sums.set(x.s, 0));

      (spec.months || []).forEach(m => {
        const tr = document.createElement('tr');

        const tdM = document.createElement('td');
        tdM.className = 'c-item';
        tdM.textContent = m.month || '';
        tr.appendChild(tdM);

        const tdC = document.createElement('td');
        tdC.className = 'c-spec';
        tdC.style.textAlign = 'right';
        tdC.textContent = String(n(m.count));
        tr.appendChild(tdC);

        seconds.forEach(x => {
          const td = document.createElement('td');
          td.className = 'c-price';

          const col = (m.cols || []).find(z => n(z.sec) === x.s);
          const oldV = col ? n(col.oldV) : 0;
          const newV = col ? n(col.newV) : 0;

          // show discount style if newV > 0 and oldV > 0
          if(newV > 0 && oldV > 0){
            td.innerHTML = `<div class="pv-price-old">${formatMoney(oldV)}</div><div class="pv-price-new">${formatMoney(newV)}</div>`;
            sums.set(x.s, sums.get(x.s) + newV);
          } else {
            td.textContent = oldV > 0 ? formatMoney(oldV) : '';
            sums.set(x.s, sums.get(x.s) + oldV);
          }

          tr.appendChild(td);
        });

        tbody2.appendChild(tr);
      });

      // optional SUM row (per specialization)
      if(spec.showSum){
        const trSum = document.createElement('tr');
        const td1 = document.createElement('td');
        td1.className = 'c-item';
        td1.innerHTML = `<strong>Spolu</strong>`;
        trSum.appendChild(td1);

        const td2 = document.createElement('td');
        td2.className = 'c-spec';
        td2.textContent = '';
        trSum.appendChild(td2);

        seconds.forEach(x => {
          const td = document.createElement('td');
          td.className = 'c-price';
          td.innerHTML = `<strong>${formatMoney(sums.get(x.s) || 0)}</strong>`;
          trSum.appendChild(td);
        });

        tbody2.appendChild(trSum);
      }

      t.appendChild(tbody2);
      secDiv.appendChild(t);
    });

    // DP note (inside DP section, not at end of doc)
    if(s.dpNoteOn){
      const dpNote = document.createElement('div');
      dpNote.className = 'pv-note-block';
      dpNote.textContent =
        'Aktu√°lny poƒçet funguj√∫cich panelov v dan√Ω mesiac, dƒ∫≈æka sluƒçky, priemern√° n√°v≈°tevnos≈• za dan√Ω mesiac, pl√°novan√Ω poƒçet prehran√≠ za dan√Ω mesiac, re√°lny poƒçet prehran√≠ za dan√Ω mesiac, poƒçet mo≈æn√Ωch viden√≠ za dan√Ω mesiac. Komunik√°cia na pacienta prebieha prostredn√≠ctvom dynamickej sluƒçky zlo≈æenej z kr√°tkych animovan√Ωch sekvenci√≠. Sluƒçka m√° 8 ‚Äì 10 min√∫t a sklad√° sa z ƒçasti vyhraden√©ho pre lek√°ra (30 %), edukaƒçnej ƒçasti (30 %) a komerƒçnej ƒçasti (40 %). Komerƒçn√° ƒças≈• je obmedzen√°, aby bola Va≈°a kampa≈à ƒço najviac viditeƒæn√°. Rozmer digit√°lneho panelu je 55 √ó 100 cm, umiestnen√Ω priamo v ƒçak√°rni lek√°ra. Poƒçty panelov s√∫ odhadovan√©. Fakturova≈• budeme len re√°lny poƒçet panelov v dan√Ω mesiac.';
      secDiv.appendChild(dpNote);
    }

    const divLine = document.createElement('div');
    divLine.className = 'pv-divider';
    secDiv.appendChild(divLine);

    pvSections.appendChild(secDiv);
  });

  // grand total (optional)
  const pvGrandWrap = document.getElementById('pvGrandWrap');
  pvGrandWrap.innerHTML = '';
  if(state.showGrand){
    const grand = document.createElement('div');
    grand.className = 'pv-note-block';
    grand.style.display = 'flex';
    grand.style.justifyContent = 'flex-end';
    grand.innerHTML = `<div style="text-align:right; border-top:1px solid #000; padding-top:4mm; width:260px;">
      <div style="font-weight:700;">Spolu</div>
      <div style="font-size:16px; font-weight:800; margin-top:2mm;">${formatMoney(grandTotal)}</div>
    </div>`;
    pvGrandWrap.appendChild(grand);
  }
}

function escapeHtml(s){
  return String(s || '')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#39;");
}

/* ===============================
   BUTTONS
================================ */
document.getElementById('btnAddSection').addEventListener('click', addSection);
document.getElementById('btnAddSectionBottom').addEventListener('click', addSection);

document.getElementById('btnPrint').addEventListener('click', () => {
  renderPDF();
  setTimeout(() => window.print(), 80);
});

document.getElementById('btnReset').addEventListener('click', () => {
  document.getElementById('offerTitle').value = 'Cenov√° ponuka';
  document.getElementById('offerSubtitle').value = '';
  document.getElementById('fileName').value = '';
  document.getElementById('pdfImages').value = 'with';
  document.getElementById('pdfShowGrand').value = 'no';
  document.getElementById('stdNoteOn').value = 'yes';
  sectionsWrap.innerHTML = '';
  applyImagesSetting();
  addSection();
});

/* ===============================
   INIT
================================ */
applyImagesSetting();
addSection();
</script>

</body>
</html>
