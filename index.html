<!doctype html>
<html lang="sk">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Cenov√° ponuka</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Onest:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
*{ box-sizing:border-box; }
body{ margin:0; font-family:"Onest", system-ui, sans-serif; background:#fff; color:#000; }
.wrap{ max-width:1200px; margin:0 auto; padding:24px; }
h1{ margin:0 0 14px 0; font-size:28px; font-weight:800; }

.toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:12px 0 16px; }
.btn{ border-radius:999px; padding:10px 16px; border:1px solid #000; background:#fff; font-weight:800; cursor:pointer; }
.btn.primary{ background:#000; color:#fff; }
.btn.secondary{ background:#f2f2f2; border-color:#d0d0d0; }
.btn.ghost{ background:#fff; border-color:#d0d0d0; }
.hint{ color:#666; font-size:13px; margin-top:4px; }

label{
  font-size:12px; text-transform:uppercase; letter-spacing:.08em; font-weight:800;
  display:block; margin-bottom:4px; color:#111;
}
input, select, textarea{
  width:100%; padding:10px 12px; border-radius:12px; border:1px solid #ccc;
  font-family:inherit; font-size:14px; background:#fff;
}
input[type="number"]{ text-align:right; }
textarea{ min-height:70px; resize:vertical; }
.small{ font-size:12px; color:#666; }

.card{ border:1px solid #ddd; border-radius:16px; padding:16px; margin-bottom:16px; }
.card h2{ margin:0 0 12px 0; font-size:18px; font-weight:800; }

.grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px; }
.grid-4{ display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:14px; }
@media (max-width: 900px){
  .grid-2,.grid-3,.grid-4{ grid-template-columns:1fr; }
}

.sections{ display:flex; flex-direction:column; gap:14px; }
.section{ border:2px solid #000; border-radius:16px; padding:14px; }
.section-head{
  display:flex; gap:10px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap;
  margin-bottom:10px; padding-bottom:10px; border-bottom:1px dashed #ddd;
}
.section-title{ display:grid; grid-template-columns:1fr 220px 220px; gap:12px; width:100%; }
@media (max-width: 900px){ .section-title{ grid-template-columns:1fr; } }
.section-actions{ display:flex; gap:10px; align-items:center; justify-content:flex-end; flex-wrap:wrap; }
.icon-btn{
  width:40px; height:40px; border-radius:999px; border:1px solid #d0d0d0;
  background:#f2f2f2; cursor:pointer; display:flex; align-items:center; justify-content:center;
}
.section-bottom{
  margin-top:12px; padding-top:12px; border-top:1px dashed #ddd;
  display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;
}

.items{ display:flex; flex-direction:column; gap:12px; margin-top:12px; }
.item{ border:1px solid #ddd; border-radius:14px; padding:12px; }
.item-head{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
.item-head .left{ font-weight:800; }
.item-head .right{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
.item-foot{
  margin-top:10px; display:flex; justify-content:space-between; align-items:flex-end;
  gap:12px; flex-wrap:wrap;
}
.price-block{ text-align:right; min-width:260px; }
.price-old{ font-size:12px; color:#777; text-decoration:line-through; min-height:16px; }
.price-main{ font-weight:800; font-size:18px; }
.price-period{ margin-top:2px; font-size:11px; color:#777; }

.or-sep{
  text-align:center; font-weight:900; letter-spacing:.12em; color:#111;
  background:#f3f3f3; border:1px solid #ddd; border-radius:999px; padding:8px 10px; margin:2px 0;
}

.preview-row{ margin-top:10px; display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap; }
.thumb{
  width:120px; height:90px; border:1px solid #ddd; border-radius:12px; overflow:hidden;
  background:#f6f6f6; display:flex; align-items:center; justify-content:center;
}
.thumb img{ width:100%; height:100%; object-fit:cover; border-radius:10px; }
.note-box{ margin-top:10px; }
.images-off .img-controls{ display:none !important; }

.end-settings{ border-top:1px dashed #ddd; padding-top:12px; margin-top:12px; }

/* DIGITAL PANEL UI */
.dp-wrap{ margin-top:12px; }
.dp-card{
  border:1px solid #ddd; border-radius:14px; padding:12px; margin-top:12px;
}
.dp-title{ font-weight:900; margin-bottom:10px; }
.dp-row-head{
  display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
  padding-bottom:10px; border-bottom:1px dashed #ddd; margin-bottom:10px;
}
.badge{
  display:inline-block; padding:6px 10px; border-radius:999px; background:#f3f3f3; border:1px solid #ddd;
  font-size:12px; font-weight:800;
}
.dp-inline-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.dp-mini-btn{
  border-radius:999px; padding:8px 12px; border:1px solid #d0d0d0; background:#fff; cursor:pointer; font-weight:800;
}
.dp-mini-btn.danger{ border-color:#000; }
.dp-table{
  width:100%; border-collapse:collapse; table-layout:fixed; margin-top:8px;
}
.dp-table th{
  text-align:left; font-size:10px; text-transform:uppercase; letter-spacing:.08em;
  border-bottom:1px solid #000; padding-bottom:6px;
}
.dp-table td{ padding:8px 0; vertical-align:middle; border-bottom:1px solid #eee; }
.dp-table .r{ text-align:right; }
.dp-table .c{ text-align:center; }
.dp-orange{ color:#d35400; font-weight:900; }

/* PRINT / PDF */
.print-view{ display:none; }
.print-page{
  width:210mm; min-height:297mm; margin:0 auto; background:#fff; border:2px solid #000;
  padding:18mm 14mm; position:relative;
}
.pv-logo{ position:absolute; top:10mm; right:14mm; width:26mm; height:auto; opacity:0.95; }

.pv-gutter{
  position:absolute; left:14mm; top:18mm; bottom:18mm; width:42mm;
  display:flex; flex-direction:column; gap:10mm;
}

/* jemnej≈°ie rohy fotiek */
.pv-gutter .pv-img{
  width:100%;
  border-radius:2mm;
  overflow:hidden;
  border:1px solid #ddd;
  background:#f6f6f6;
}
.pv-gutter .pv-img img{ width:100%; height:auto; display:block; }

.pv-content{ margin-left:48mm; }

.pv-header{ margin-bottom:18mm; }
.pv-title{ font-size:34px; font-weight:800; }
.pv-subtitle{ font-size:16px; margin-top:4px; font-weight:500; }

.pv-section{ margin-top:14mm; }
.pv-section-name{ font-size:13px; font-weight:700; }
.pv-section-period{ margin-top:2mm; font-size:12px; font-weight:500; color:#111; }

.pv-table{
  margin-top:6mm; width:100%; border-collapse:collapse; table-layout:fixed; font-size:11.5px;
}
.pv-table th{
  text-align:left; font-size:10px; text-transform:uppercase; letter-spacing:.08em;
  border-bottom:1px solid #000; padding-bottom:6px;
}
.pv-table td{ padding:8px 0; vertical-align:top; }
.c-item{ width:36%; }
.c-spec{ width:20%; }
.c-qty{ width:10%; text-align:right; }
.c-price{ width:14%; text-align:right; }
.c-disc{ width:14%; text-align:right; }
.c-total{ width:16%; text-align:right; }

.pv-item-title{ font-weight:700; }
.pv-item-note{ font-size:10.5px; margin-top:2px; color:#111; }
.pv-item-period{ margin-top:3px; font-size:10px; color:#777; }

.pv-divider{ margin-top:10mm; border-top:1px solid #000; }

.pv-grand{ margin-top:10mm; display:flex; justify-content:flex-end; }
.pv-grand-box{
  width:260px; border-top:1px solid #000; padding-top:6mm; text-align:right; font-size:12px;
}
.pv-grand-box .lbl{ color:#111; font-weight:700; }
.pv-grand-box .val{ font-size:16px; font-weight:800; margin-top:2mm; }

.pv-no-images .pv-gutter{ display:none; }
.pv-no-images .pv-content{ margin-left:0; }

.pv-or-row td{
  padding:10px 0; text-align:center !important; font-weight:900; letter-spacing:.12em; color:#111;
}

/* Digital PDF blocks */
.pv-block-title{ font-size:12px; font-weight:900; margin-top:6mm; }
.pv-dp-table{
  width:100%; border-collapse:collapse; table-layout:fixed; margin-top:3mm; font-size:11.5px;
}
.pv-dp-table th{
  text-align:left; font-size:10px; text-transform:uppercase; letter-spacing:.08em;
  border-bottom:1px solid #000; padding-bottom:6px;
}
.pv-dp-table td{ padding:8px 0; border-bottom:1px solid #eee; vertical-align:top; }
.pv-dp-table .r{ text-align:right; }
.pv-dp-table .c{ text-align:center; }
.pv-dp-orange{ color:#d35400; font-weight:900; }

/* Totals row under DP columns */
.pv-dp-total-row td{
  border-top:1px solid #000;
  border-bottom:none;
  padding-top:10px;
  font-weight:900;
}

/* Notes at section end */
.pv-notes{
  margin-top:6mm;
  font-size:10.5px;
  color:#111;
}
.pv-notes .ttl{
  font-weight:900;
  margin-bottom:2mm;
}
.pv-notes .ln{
  margin-top:1.5mm;
}
.pv-notes .lbl{
  font-weight:900;
}

/* Global end notes */
.pv-global-note{
  margin-top:8mm;
  font-size:10.8px;
  color:#111;
  line-height:1.35;
}
.pv-global-note .ttl{ font-weight:900; margin-bottom:2mm; }

.pv-vat{
  margin-top:10mm;
  font-size:11px;
  font-weight:700;
  color:#111;
}

@media print{
  .wrap{ display:none !important; }
  .print-view{ display:block !important; }
  body{ margin:0; }
  @page{ margin:0; }
}
</style>
</head>

<body>

<div class="wrap" id="appRoot">
  <h1>Cenov√° ponuka ‚Äì formul√°r</h1>

  <div class="toolbar">
    <button class="btn primary" id="btnPrint" type="button">Export do PDF</button>
    <button class="btn secondary" id="btnAddSection" type="button">+ Prida≈• sekciu</button>
    <button class="btn ghost" id="btnReset" type="button">Vymaza≈• (demo)</button>
  </div>
  <div class="hint">Cena spolu v riadku je v≈ædy. Voliteƒæn√Ω je iba fin√°lny s√∫ƒçet v≈°etk√Ωch polo≈æiek.</div>

  <div class="card">
    <h2>Z√°klad ponuky</h2>

    <div class="grid-2">
      <div>
        <label for="offerTitle">N√°zov ponuky</label>
        <input id="offerTitle" value="Cenov√° ponuka">
      </div>
      <div>
        <label for="offerSubtitle">Obdobie alebo podnadpis</label>
        <input id="offerSubtitle" placeholder="napr. Q4 2026 ‚Ä¢ n√°zov produktu ‚Ä¢ pozn√°mka" value="">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label for="pdfImages">PDF obr√°zky</label>
        <select id="pdfImages">
          <option value="with" selected>S obr√°zkami</option>
          <option value="without">Bez obr√°zkov (cel√° ≈°√≠rka)</option>
        </select>
      </div>
      <div>
        <label for="pdfShowGrand">Zobrazi≈• fin√°lny s√∫ƒçet (Spolu) v PDF?</label>
        <select id="pdfShowGrand">
          <option value="yes" selected>√Åno</option>
          <option value="no">Nie</option>
        </select>
        <div class="small">Pozor: ‚ÄûCena spolu‚Äú pri polo≈æk√°ch je v≈ædy, toto je len fin√°lny s√∫ƒçet na konci.</div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>Text pod ≈°tandardn√© plochy v PDF (raz na konci)</label>
        <select id="stdNoteEnabled">
          <option value="yes" selected>√Åno</option>
          <option value="no">Nie</option>
        </select>
        <div class="small">Zobraz√≠ sa v PDF raz na konci (po v≈°etk√Ωch sekci√°ch).</div>
      </div>
      <div></div>
    </div>
  </div>

  <div class="card">
    <h2>Sekcie</h2>
    <div class="sections" id="sections"></div>

    <div class="end-settings">
      <div class="grid-2">
        <div class="small">Tip: Logo IDS sa naƒç√≠ta zo s√∫boru <strong>ids-logo.png</strong> v rovnakom prieƒçinku ako index.html.</div>
        <div style="text-align:right;">
          <button class="btn secondary" id="btnAddSectionBottom" type="button">+ Prida≈• sekciu</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PRINT VIEW -->
<section class="print-view" id="printView">
  <div class="print-page" id="printPage">
    <img class="pv-logo" id="pvLogo" src="ids-logo.png" alt="IDS logo" />
    <div class="pv-gutter" id="pvGutter"></div>

    <div class="pv-content">
      <div class="pv-header">
        <div class="pv-title" id="pvTitle">Cenov√° ponuka</div>
        <div class="pv-subtitle" id="pvSubtitle"></div>
      </div>

      <div id="pvSections"></div>
      <div id="pvGrandWrap"></div>

      <div id="pvGlobalNotes"></div>
      <div class="pv-vat" id="pvVat">Ceny s√∫ bez DPH.</div>
    </div>
  </div>
</section>

<!-- DATALISTS -->
<datalist id="dlSectionNames">
  <option value="Komunik√°cia v ƒçak√°rni pediatra"></option>
  <option value="Komunik√°cia v ƒçak√°rni gynekol√≥ga"></option>
  <option value="Komunik√°cia v ƒçak√°rni praktick√©ho lek√°ra"></option>
  <option value="Komunik√°cia v ƒçak√°rni urol√≥ga"></option>
  <option value="Osobn√° n√°v≈°teva lek√°ra"></option>
  <option value="Komunik√°cia v lek√°rni"></option>
  <option value="Komunik√°cia v ƒçak√°rni gastroenterol√≥ga"></option>
  <option value="N√°v≈°teva gynekol√≥ga"></option>
  <option value="N√°v≈°teva praktick√©ho lek√°ra"></option>
  <option value="N√°v≈°teva odbornej verejnosti"></option>
  <option value="Digit√°lny panel v ƒçak√°rni lek√°ra"></option>
</datalist>

<datalist id="dlTypes">
  <option value="A3 plag√°t"></option>
  <option value="B1 plag√°t"></option>
  <option value="Statick√Ω plag√°t"></option>
  <option value="Umiestnenie let√°kov"></option>
  <option value="Odovzdanie materi√°lov"></option>
  <option value="A3 plag√°t s umiestnen√≠m let√°ku pod plag√°tom"></option>
  <option value="B1 plag√°t s umiestnen√≠m let√°ku pod plag√°tom"></option>
  <option value="Umiestnenie materi√°lov do ƒçak√°rni praktick√Ωch lek√°rov"></option>
  <option value="Umiestnenie materi√°lov do ƒçak√°rni pediatrov"></option>
  <option value="Umiestnenie materi√°lov do ƒçak√°rni gynekol√≥gov"></option>
  <option value="Umiestnenie statick√©ho plag√°tu v sieti IDS"></option>
  <option value="Umiestnenie statick√©ho plag√°tu mimo siete IDS"></option>
  <option value="Osobne odovzdanie materi√°lov do ambulancii (v sieti IDS)"></option>
  <option value="Osobne odovzdanie materi√°lov do ambulancii (mimo siete IDS)"></option>
  <option value="Tlaƒç materi√°lov"></option>
  <option value="Odovzdanie materi√°lov do ambulanci√≠"></option>
</datalist>

<!-- TEMPLATES -->
<template id="tplSection">
  <div class="section" data-section>
    <div class="section-head">
      <div class="section-title">
        <div>
          <label>N√°zov sekcie</label>
          <input data-sec-name list="dlSectionNames" placeholder="napr. Komunik√°cia v ƒçak√°rni pediatra" value="">
          <div class="small">M√¥≈æe≈° vybra≈• zo zoznamu alebo nap√≠sa≈• vlastn√Ω n√°zov.</div>
        </div>
        <div>
          <label>Obdobie (Q)</label>
          <input data-sec-period placeholder="napr. Q4 2026" value="">
        </div>
        <div>
          <label>Typ sekcie</label>
          <select data-sec-kind>
            <option value="standard" selected>≈†tandard</option>
            <option value="digital">Digit√°lny panel</option>
          </select>
          <div class="small">Digit√°lny panel m√° mesaƒçn√© v√Ωpoƒçty.</div>
        </div>
      </div>

      <div class="section-actions">
        <button class="icon-btn" type="button" title="Odstr√°ni≈• sekciu" data-del-section>üóëÔ∏è</button>
      </div>
    </div>

    <!-- STANDARD -->
    <div data-standard>
      <div class="items" data-items></div>
      <div class="section-bottom">
        <button class="btn secondary" type="button" data-add-item>+ Prida≈• polo≈æku</button>
      </div>
    </div>

    <!-- DIGITAL PANEL -->
    <div data-digital style="display:none;">
      <div class="dp-wrap">

        <div class="dp-card">
          <div class="dp-row-head">
            <div class="dp-title">Spot v digit√°lnom paneli ‚Äì nacenenie (max. 3 stƒ∫pce v PDF)</div>
          </div>

          <table class="dp-table">
            <thead>
              <tr>
                <th style="width:18%;">Poƒçet sek√∫nd</th>
                <th style="width:22%;" class="r">Cena (be≈æn√°)</th>
                <th style="width:22%;" class="r">Zv√Ωhodnen√° cena</th>
                <th style="width:18%;" class="c">Zobrazi≈• v PDF</th>
                <th style="width:20%;" class="r"></th>
              </tr>
            </thead>
            <tbody data-dp-spots></tbody>
          </table>

          <div class="small" style="margin-top:8px;">
            Tip: ak nechce≈° pon√∫knu≈• 20s alebo 30s, nechaj cenu pr√°zdnu alebo vypni ‚ÄûZobrazi≈• v PDF‚Äú.
          </div>
        </div>

        <div class="dp-card">
          <div class="dp-row-head">
            <div class="dp-title">≈†pecializ√°cie + mesiace</div>
            <div class="dp-inline-actions">
              <button class="dp-mini-btn" type="button" data-dp-add-aud>+ Prida≈• ≈°pecializ√°ciu</button>
            </div>
          </div>

          <div data-dp-auds></div>

          <div class="small" style="margin-top:10px;">
            Ak je v mesiaci ‚ÄûAkcia = √°no‚Äú a zv√Ωhodnen√° cena je vyplnen√°, pou≈æije sa zv√Ωhodnen√° cena.
          </div>
        </div>

        <!-- DP note toggle + text -->
        <div class="dp-card">
          <div class="dp-row-head">
            <div class="dp-title">Text pod digit√°lne panely v PDF</div>
          </div>

          <div class="grid-2">
            <div>
              <label>Zobrazi≈• tento text v PDF?</label>
              <select data-dp-note-enabled>
                <option value="yes" selected>√Åno</option>
                <option value="no">Nie</option>
              </select>
            </div>
            <div></div>
          </div>

          <div style="margin-top:10px;">
            <label>Text (prep√≠sateƒæn√Ω)</label>
            <textarea data-dp-note-text>
S√∫ƒças≈•ou kampane u digit√°lnych panelov je: Aktu√°lny poƒçet funguj√∫cich panelov v dan√Ω mesiac, dƒ∫≈æka sluƒçky, priemern√° n√°v≈°tevnos≈• za dan√Ω mesiac, pl√°novan√Ω poƒçet prehran√≠ za dan√Ω mesiac, re√°lny poƒçet prehran√≠ za dan√Ω mesiac, poƒçet mo≈æn√Ωch viden√≠ za dan√Ω mesiac. Komunik√°cia na pacienta prebieha prostredn√≠ctvom dynamickej sluƒçky zlo≈æenej z kr√°tkych animovan√Ωch sekvenci√≠. Sluƒçka m√° 8 - 10 min√∫t a sklad√° sa z ƒçasti vyhraden√©ho pre lek√°ra (30 %), edukaƒçnej ƒçasti (30 %) a komerƒçnej ƒçasti (40%). Komerƒçn√° ƒças≈• je obmedzen√°, aby bola Va≈°a kampa≈à ƒço najviac viditeƒæn√°. Rozmer digit√°lneho panelu je 55 x 100 cm, umiestnen√Ω priamo v ƒçak√°rni lek√°ra. Poƒçty panelov s√∫ odhadovan√©. Fakturova≈• budeme len re√°lny poƒçet panelov v dan√Ω mesiac.
            </textarea>
            <div class="small">V PDF sa zobraz√≠ na konci digit√°lnej sekcie.</div>
          </div>
        </div>

        <!-- IMAGES moved to end -->
        <div class="dp-card img-controls">
          <div class="dp-row-head">
            <div class="dp-title">Obr√°zky sekcie (voliteƒæn√©) <span class="badge">id√∫ do PDF naƒæavo</span></div>
          </div>

          <div class="grid-3">
            <div>
              <label>Obr√°zok 1</label>
              <input data-dp-img1 type="file" accept="image/*">
              <div class="thumb" data-dp-thumb1><span class="small">bez obr√°zka</span></div>
            </div>
            <div>
              <label>Obr√°zok 2</label>
              <input data-dp-img2 type="file" accept="image/*">
              <div class="thumb" data-dp-thumb2><span class="small">bez obr√°zka</span></div>
            </div>
            <div>
              <label>Obr√°zok 3</label>
              <input data-dp-img3 type="file" accept="image/*">
              <div class="thumb" data-dp-thumb3><span class="small">bez obr√°zka</span></div>
            </div>
          </div>

          <div class="small" style="margin-top:8px;">
            Tip: ak m√°≈° iba 1‚Äì2 fotky, nechaj zvy≈°ok pr√°zdny.
          </div>
        </div>

      </div>
    </div>

  </div>
</template>

<template id="tplOrSep">
  <div class="or-sep" data-or-sep>A L E B O</div>
</template>

<template id="tplItem">
  <div class="item" data-item>
    <div class="item-head">
      <div class="left">Polo≈æka v tejto sekcii</div>
      <div class="right">
        <button class="btn ghost" type="button" data-add-or>+ ALEBO</button>
        <button class="icon-btn" type="button" title="Odstr√°ni≈• polo≈æku" data-del-item>üóëÔ∏è</button>
      </div>
    </div>

    <div class="grid-2">
      <div>
        <label>Typ produktu (voƒæn√Ω text)</label>
        <input data-type list="dlTypes" placeholder="napr. B1 plag√°t">
        <div class="small">N√°vrhy s√∫ v zozname, ale m√¥≈æe≈° nap√≠sa≈• ƒçokoƒævek.</div>
      </div>
      <div>
        <label>Rozmer</label>
        <input data-dim placeholder="‚Äî">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>N√°zov polo≈æky (prep√≠sateƒæn√©)</label>
        <input data-title placeholder="napr. B1 plag√°t">
      </div>
      <div>
        <label>Doplnenie / pozn√°mka (riadok pod n√°zvom)</label>
        <input data-note placeholder="napr. + umiestnenie let√°kov do u≈°ka">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;">
      <div>
        <label>Cenov√Ω re≈æim</label>
        <select data-price-mode>
          <option value="unit" selected>Cena za kus √ó poƒçet</option>
          <option value="fixed">Fixn√° cena spolu</option>
        </select>
      </div>
      <div>
        <label>Poƒçet</label>
        <div class="grid-2" style="grid-template-columns: 1fr 1fr; gap:10px;">
          <select data-qtymode title="Re≈æim poƒçtu">
            <option value="exact" selected>Presn√Ω</option>
            <option value="max">Max</option>
          </select>
          <input data-qty type="number" min="0" step="1" value="1">
        </div>
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px;" data-unit-wrap>
      <div>
        <label>Cena za kus</label>
        <input data-price type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div>
        <label>Zv√Ωhodnen√° cena za kus</label>
        <input data-discount type="number" min="0" step="0.01" placeholder="0.00">
      </div>
    </div>

    <div class="grid-2" style="margin-top:12px; display:none;" data-fixed-wrap>
      <div>
        <label>Fixn√° cena spolu</label>
        <input data-fixed-total type="number" min="0" step="0.01" placeholder="0.00">
      </div>
      <div></div>
    </div>

    <div class="item-foot">
      <div style="min-width:260px;">
        <label>Obdobie pod cenou</label>
        <input data-period>
      </div>

      <div class="price-block">
        <div class="price-old" data-old></div>
        <div class="price-main" data-total>0,00 ‚Ç¨</div>
        <div class="price-period">(v√Ωpoƒçet podƒæa zvolen√©ho re≈æimu)</div>
      </div>
    </div>

    <div class="preview-row img-controls">
      <div>
        <label>Obr√°zok (voliteƒæn√©)</label>
        <input data-img type="file" accept="image/*">
      </div>

      <div class="thumb" data-thumb>
        <span class="small">bez obr√°zka</span>
      </div>
    </div>

    <div class="note-box">
      <label>Vlastn√° pozn√°mka pod polo≈ækou (voliteƒæn√©)</label>
      <textarea data-extra placeholder="napr. S√∫ƒças≈•ou je fotodokument√°cia a zoznam, kde sa materi√°l odovzdal."></textarea>
      <div class="small">V PDF sa zobraz√≠ a≈æ na konci sekcie (nie pri polo≈æke).</div>
    </div>
  </div>
</template>

<!-- DIGITAL PANEL subtemplates -->
<template id="tplDpSpot">
  <tr data-dp-spot>
    <td><input data-dp-seconds type="number" min="1" step="1" value="15" readonly></td>
    <td class="r"><input data-dp-price type="number" min="0" step="0.01" placeholder="0.00"></td>
    <td class="r"><input data-dp-promo type="number" min="0" step="0.01" placeholder="0.00"></td>
    <td class="c">
      <select data-dp-enabled>
        <option value="yes" selected>√°no</option>
        <option value="no">nie</option>
      </select>
    </td>
    <td class="r"></td>
  </tr>
</template>

<template id="tplDpAud">
  <div class="dp-card" data-dp-aud>
    <div class="dp-row-head">
      <div class="dp-title">
        ≈†pecializ√°cia:
        <input data-dp-aud-name style="display:inline-block; width:360px; max-width:100%; margin-left:8px;"
               placeholder="napr. Praktick√Ω lek√°r" value="Praktick√Ω lek√°r">
      </div>
      <div class="dp-inline-actions">
        <div style="display:flex; gap:8px; align-items:center;">
          <input data-dp-panels-all type="number" min="0" step="1" placeholder="Poƒçet" style="width:120px;">
          <button class="dp-mini-btn" type="button" data-dp-apply-panels>Pou≈æi≈• rovnak√Ω poƒçet v≈°ade</button>
        </div>
        <button class="dp-mini-btn" type="button" data-dp-add-month>+ Prida≈• mesiac</button>
        <button class="dp-mini-btn danger" type="button" data-dp-del-aud>Odstr√°ni≈•</button>
      </div>
    </div>

    <table class="dp-table">
      <thead>
        <tr>
          <th style="width:30%;">Term√≠n</th>
          <th style="width:25%;" class="r">Poƒçet panelov</th>
          <th style="width:25%;" class="c">Akcia?</th>
          <th style="width:20%;" class="r">Akcia</th>
        </tr>
      </thead>
      <tbody data-dp-months></tbody>
    </table>
  </div>
</template>

<template id="tplDpMonth">
  <tr data-dp-month>
    <td>
      <select data-dp-month-name>
        <option>Janu√°r</option><option>Febru√°r</option><option>Marec</option><option>Apr√≠l</option>
        <option>M√°j</option><option>J√∫n</option><option>J√∫l</option><option>August</option>
        <option>September</option><option>Okt√≥ber</option><option>November</option><option>December</option>
      </select>
    </td>
    <td class="r"><input data-dp-panels type="number" min="0" step="1" value="0"></td>
    <td class="c">
      <select data-dp-use-promo>
        <option value="no" selected>nie</option>
        <option value="yes">√°no</option>
      </select>
    </td>
    <td class="r"><button class="dp-mini-btn danger" type="button" data-dp-del-month>Vymaza≈•</button></td>
  </tr>
</template>

<script>
/* ========= UTIL ========= */
const moneyFmt = new Intl.NumberFormat('sk-SK', { style:'currency', currency:'EUR' });
function n(v){ const x = Number(v); return Number.isFinite(x) ? x : 0; }
function formatMoney(val){ return moneyFmt.format(val); }
function normalize(s){ return (s || '').trim().toLowerCase(); }

/* ========= PRESETS (standard items) ========= */
function presetFromType(rawType){
  const t = normalize(rawType);

  if(t === 'a3 plag√°t' || t === 'a3 plakat'){
    return { dim:'42 √ó 29,7 cm', title:'A3 plag√°t', period:'za 3 mesiace' };
  }
  if(t === 'b1 plag√°t' || t === 'b1 plakat' || t === 'b1'){
    return { dim:'70 √ó 100 cm', title:'B1 plag√°t', period:'za 3 mesiace' };
  }
  if(t === 'statick√Ω plag√°t' || t === 'staticky plakat'){
    return { dim:'42 √ó 29,7 cm', title:'Statick√Ω plag√°t', period:'za jednu n√°v≈°tevu' };
  }
  if(t === 'a3 plag√°t s umiestnen√≠m let√°ku pod plag√°tom' || t === 'a3 plakat s umiestnen√≠m let√°ku pod plag√°tom'){
    return { dim:'42 √ó 29,7 cm', title:'A3 plag√°t s umiestnen√≠m let√°ku pod plag√°tom', period:'za 3 mesiace' };
  }
  if(t === 'b1 plag√°t s umiestnen√≠m let√°ku pod plag√°tom' || t === 'b1 plakat s umiestnen√≠m let√°ku pod plag√°tom'){
    return { dim:'70 √ó 100 cm', title:'B1 plag√°t s umiestnen√≠m let√°ku pod plag√°tom', period:'za 3 mesiace' };
  }

  const oneVisitList = [
    'umiestnenie materi√°lov do ƒçak√°rni praktick√Ωch lek√°rov',
    'umiestnenie materi√°lov do ƒçak√°rni pediatrov',
    'umiestnenie materi√°lov do ƒçak√°rni gynekol√≥gov',
    'umiestnenie statick√©ho plag√°tu v sieti ids',
    'umiestnenie statick√©ho plag√°tu mimo siete ids',
    'osobne odovzdanie materi√°lov do ambulancii (v sieti ids)',
    'osobne odovzdanie materi√°lov do ambulancii (mimo siete ids)',
  ];
  if(oneVisitList.includes(t)){
    return { dim:'', title:rawType || '', period:'za jednu n√°v≈°tevu' };
  }

  if(t === 'tlaƒç materi√°lov' || t === 'tlac materialov'){
    return { dim:'', title:'Tlaƒç materi√°lov', period:'', suggestMode:'fixed' };
  }

  return { dim:'', title:rawType || '', period:'za 3 mesiace' };
}

/* ========= DOM refs ========= */
const appRoot = document.getElementById('appRoot');
const sectionsWrap = document.getElementById('sections');

const tplSection = document.getElementById('tplSection');
const tplItem = document.getElementById('tplItem');
const tplOrSep = document.getElementById('tplOrSep');

const tplDpSpot = document.getElementById('tplDpSpot');
const tplDpAud  = document.getElementById('tplDpAud');
const tplDpMonth= document.getElementById('tplDpMonth');

const pdfImagesSel = document.getElementById('pdfImages');

/* ========= UI images on/off ========= */
function applyImagesSetting(){
  const mode = pdfImagesSel.value;
  if(mode === 'without') appRoot.classList.add('images-off');
  else appRoot.classList.remove('images-off');
}
pdfImagesSel.addEventListener('change', applyImagesSetting);

/* ========= STANDARD ITEM logic ========= */
function setThumb(itemEl, dataUrl){
  const thumb = itemEl.querySelector('[data-thumb]');
  thumb.innerHTML = '';
  if(!dataUrl){
    thumb.innerHTML = '<span class="small">bez obr√°zka</span>';
    itemEl.dataset.img = '';
    return;
  }
  const img = document.createElement('img');
  img.src = dataUrl;
  thumb.appendChild(img);
  itemEl.dataset.img = dataUrl;
}

function getItemGroupId(itemEl){ return itemEl.dataset.orGroup || ''; }

function togglePriceMode(itemEl){
  const mode = itemEl.querySelector('[data-price-mode]').value;
  const unitWrap = itemEl.querySelector('[data-unit-wrap]');
  const fixedWrap = itemEl.querySelector('[data-fixed-wrap]');
  if(mode === 'fixed'){
    unitWrap.style.display = 'none';
    fixedWrap.style.display = 'grid';
  } else {
    unitWrap.style.display = 'grid';
    fixedWrap.style.display = 'none';
  }
  recalcItem(itemEl);
}

function recalcItem(itemEl){
  const priceMode = itemEl.querySelector('[data-price-mode]').value;
  const qtyMode = itemEl.querySelector('[data-qtymode]').value;

  const qty = n(itemEl.querySelector('[data-qty]').value);
  const unitPrice = n(itemEl.querySelector('[data-price]').value);
  const disc = n(itemEl.querySelector('[data-discount]').value);
  const fixedTotal = n(itemEl.querySelector('[data-fixed-total]').value);

  let total = 0;
  let oldText = '';

  if(priceMode === 'fixed'){
    total = fixedTotal;
    oldText = '';
  } else {
    const unit = disc > 0 ? disc : unitPrice;
    total = unit * qty;
    if(disc > 0 && unitPrice > 0) oldText = formatMoney(unitPrice);
  }

  itemEl.querySelector('[data-old]').textContent = oldText;
  const shown = (qtyMode === 'max') ? ('max. ' + formatMoney(total)) : formatMoney(total);
  itemEl.querySelector('[data-total]').textContent = shown;
}

function applyPreset(itemEl){
  const typeEl = itemEl.querySelector('[data-type]');
  const dimEl = itemEl.querySelector('[data-dim]');
  const titleEl = itemEl.querySelector('[data-title]');
  const periodEl = itemEl.querySelector('[data-period]');
  const modeEl = itemEl.querySelector('[data-price-mode]');

  const p = presetFromType(typeEl.value);

  if(p.dim) dimEl.value = p.dim;
  if(!titleEl.value && p.title) titleEl.value = p.title;

  const curPer = (periodEl.value ?? '').trim();
  const defaults = new Set(['za 3 mesiace','za jednu n√°v≈°tevu','']);
  if(curPer === '' || defaults.has(curPer)){
    periodEl.value = p.period ?? 'za 3 mesiace';
  }

  if(p.suggestMode === 'fixed'){
    modeEl.value = 'fixed';
    togglePriceMode(itemEl);
  }
}

function wireItem(itemEl){
  const typeInput = itemEl.querySelector('[data-type]');
  const imgInput = itemEl.querySelector('[data-img]');

  if((itemEl.querySelector('[data-period]').value || '').trim() === ''){
    itemEl.querySelector('[data-period]').value = 'za 3 mesiace';
  }

  typeInput.addEventListener('change', () => { applyPreset(itemEl); recalcItem(itemEl); });
  typeInput.addEventListener('blur',   () => { applyPreset(itemEl); recalcItem(itemEl); });

  itemEl.querySelector('[data-price-mode]').addEventListener('change', () => togglePriceMode(itemEl));

  itemEl.querySelectorAll('input, select, textarea').forEach(el => {
    if(el.matches('[data-img]')) return;
    el.addEventListener('input',  () => recalcItem(itemEl));
    el.addEventListener('change', () => recalcItem(itemEl));
  });

  imgInput.addEventListener('change', () => {
    const f = imgInput.files && imgInput.files[0];
    if(!f){ setThumb(itemEl, ''); return; }
    const reader = new FileReader();
    reader.onload = () => setThumb(itemEl, String(reader.result || ''));
    reader.readAsDataURL(f);
  });

  itemEl.querySelector('[data-del-item]').addEventListener('click', () => {
    const prev = itemEl.previousElementSibling;
    const next = itemEl.nextElementSibling;
    const grp = getItemGroupId(itemEl);

    itemEl.remove();

    if(prev && prev.matches('[data-or-sep]')){
      const after = prev.nextElementSibling;
      if(!after || !after.matches('[data-item]') || getItemGroupId(after) !== grp){
        prev.remove();
      }
    }
    if(next && next.matches('[data-or-sep]')){
      const after = next.nextElementSibling;
      if(!after || !after.matches('[data-item]')){
        next.remove();
      }
    }
  });

  itemEl.querySelector('[data-add-or]').addEventListener('click', () => {
    const itemsWrap = itemEl.parentElement;
    const groupId = getItemGroupId(itemEl) || ('g' + Math.random().toString(16).slice(2));
    itemEl.dataset.orGroup = groupId;

    const maybeNext = itemEl.nextElementSibling;
    if(!(maybeNext && maybeNext.matches('[data-or-sep]'))){
      const sepNode = tplOrSep.content.cloneNode(true);
      itemsWrap.insertBefore(sepNode, itemEl.nextElementSibling);
    }

    const newNode = tplItem.content.cloneNode(true);
    const temp = document.createElement('div');
    temp.appendChild(newNode);
    const newItemEl = temp.firstElementChild;

    newItemEl.dataset.orGroup = groupId;

    const sepEl = itemEl.nextElementSibling;
    itemsWrap.insertBefore(newItemEl, sepEl.nextElementSibling);

    wireItem(newItemEl);

    newItemEl.querySelector('[data-type]').value = itemEl.querySelector('[data-type]').value;
    newItemEl.querySelector('[data-dim]').value = itemEl.querySelector('[data-dim]').value;
    newItemEl.querySelector('[data-title]').value = itemEl.querySelector('[data-title]').value;
    newItemEl.querySelector('[data-note]').value = itemEl.querySelector('[data-note]').value;
    newItemEl.querySelector('[data-period]').value = itemEl.querySelector('[data-period]').value;

    newItemEl.querySelector('[data-qty]').value = '';
    newItemEl.querySelector('[data-price]').value = '';
    newItemEl.querySelector('[data-discount]').value = '';
    newItemEl.querySelector('[data-fixed-total]').value = '';
    newItemEl.querySelector('[data-extra]').value = '';

    recalcItem(newItemEl);
  });

  setThumb(itemEl, '');
  togglePriceMode(itemEl);
  recalcItem(itemEl);
}

function addItem(itemsWrap){
  const node = tplItem.content.cloneNode(true);
  itemsWrap.appendChild(node);
  const itemEl = itemsWrap.lastElementChild;
  wireItem(itemEl);
  return itemEl;
}

/* ========= DIGITAL PANEL logic ========= */
function setThumbIn(elThumb, dataUrl){
  elThumb.innerHTML = '';
  if(!dataUrl){
    elThumb.innerHTML = '<span class="small">bez obr√°zka</span>';
    return;
  }
  const img = document.createElement('img');
  img.src = dataUrl;
  elThumb.appendChild(img);
}

function wireDpImage(secEl, inputSel, thumbSel, dsKey){
  const inp = secEl.querySelector(inputSel);
  const th  = secEl.querySelector(thumbSel);

  inp.addEventListener('change', () => {
    const f = inp.files && inp.files[0];
    if(!f){
      secEl.dataset[dsKey] = '';
      setThumbIn(th, '');
      return;
    }
    const reader = new FileReader();
    reader.onload = () => {
      const url = String(reader.result || '');
      secEl.dataset[dsKey] = url;
      setThumbIn(th, url);
    };
    reader.readAsDataURL(f);
  });

  setThumbIn(th, secEl.dataset[dsKey] || '');
}

function addDpSpotFixed(secEl, seconds){
  const spotsBody = secEl.querySelector('[data-dp-spots]');
  const node = tplDpSpot.content.cloneNode(true);
  spotsBody.appendChild(node);
  const tr = spotsBody.lastElementChild;
  tr.querySelector('[data-dp-seconds]').value = String(seconds);
}

function addDpMonthRow(monthsTbody, preset){
  const node = tplDpMonth.content.cloneNode(true);
  monthsTbody.appendChild(node);
  const tr = monthsTbody.lastElementChild;

  if(preset){
    if(preset.month) tr.querySelector('[data-dp-month-name]').value = preset.month;
    if(preset.panels != null) tr.querySelector('[data-dp-panels]').value = preset.panels;
    if(preset.promo != null) tr.querySelector('[data-dp-use-promo]').value = preset.promo ? 'yes' : 'no';
  }

  tr.querySelector('[data-dp-del-month]').addEventListener('click', () => tr.remove());
}

function applyPanelsToAll(audEl){
  const inp = audEl.querySelector('[data-dp-panels-all]');
  const v = n(inp.value);
  audEl.querySelectorAll('[data-dp-month] [data-dp-panels]').forEach(x => { x.value = String(v); });
}

function addDpAudience(secEl, presetName){
  const audsWrap = secEl.querySelector('[data-dp-auds]');
  const node = tplDpAud.content.cloneNode(true);
  audsWrap.appendChild(node);
  const audEl = audsWrap.lastElementChild;

  if(presetName) audEl.querySelector('[data-dp-aud-name]').value = presetName;

  const monthsTbody = audEl.querySelector('[data-dp-months]');

  audEl.querySelector('[data-dp-add-month]').addEventListener('click', () => addDpMonthRow(monthsTbody));
  audEl.querySelector('[data-dp-del-aud]').addEventListener('click', () => audEl.remove());
  audEl.querySelector('[data-dp-apply-panels]').addEventListener('click', () => applyPanelsToAll(audEl));

  // default 3 months
  addDpMonthRow(monthsTbody, { month:'Apr√≠l', panels:0, promo:false });
  addDpMonthRow(monthsTbody, { month:'M√°j',  panels:0, promo:false });
  addDpMonthRow(monthsTbody, { month:'J√∫n',  panels:0, promo:false });
}

function initDigitalSection(secEl){
  const spotsBody = secEl.querySelector('[data-dp-spots]');
  if(!spotsBody.children.length){
    addDpSpotFixed(secEl, 15);
    addDpSpotFixed(secEl, 20);
    addDpSpotFixed(secEl, 30);
  }

  const audsWrap = secEl.querySelector('[data-dp-auds]');
  if(!audsWrap.children.length){
    addDpAudience(secEl, 'Praktick√Ω lek√°r');
    addDpAudience(secEl, 'Pediater');
    addDpAudience(secEl, 'Gynekol√≥g');
  }
  secEl.querySelector('[data-dp-add-aud]').addEventListener('click', () => addDpAudience(secEl, 'Nov√° ≈°pecializ√°cia'));

  wireDpImage(secEl, '[data-dp-img1]', '[data-dp-thumb1]', 'dpImg1');
  wireDpImage(secEl, '[data-dp-img2]', '[data-dp-thumb2]', 'dpImg2');
  wireDpImage(secEl, '[data-dp-img3]', '[data-dp-thumb3]', 'dpImg3');
}

/* ========= SECTION logic ========= */
function toggleSectionKind(secEl){
  const kind = secEl.querySelector('[data-sec-kind]').value;
  const std = secEl.querySelector('[data-standard]');
  const dp  = secEl.querySelector('[data-digital]');

  if(kind === 'digital'){
    std.style.display = 'none';
    dp.style.display = 'block';

    const nm = secEl.querySelector('[data-sec-name]');
    const cur = (nm.value || '').trim();
    if(cur === '') nm.value = 'Digit√°lny panel v ƒçak√°rni lek√°ra';

    initDigitalSection(secEl);
  } else {
    std.style.display = 'block';
    dp.style.display = 'none';
  }
}

function addSection(){
  const node = tplSection.content.cloneNode(true);
  sectionsWrap.appendChild(node);
  const secEl = sectionsWrap.lastElementChild;

  const itemsWrap = secEl.querySelector('[data-items]');
  secEl.querySelector('[data-del-section]').addEventListener('click', () => secEl.remove());
  secEl.querySelector('[data-add-item]').addEventListener('click', () => addItem(itemsWrap));
  secEl.querySelector('[data-sec-kind]').addEventListener('change', () => toggleSectionKind(secEl));

  addItem(itemsWrap);
  toggleSectionKind(secEl);
}

/* ========= PDF RENDER ========= */
function collectStandardItems(secEl, imagesMode){
  const items = [];
  const notes = []; // move extras to end
  const container = secEl.querySelector('[data-items]');

  Array.from(container.children).forEach(child => {
    if(child.matches && child.matches('[data-or-sep]')){
      items.push({ __or:true });
      return;
    }
    if(!(child.matches && child.matches('[data-item]'))) return;

    const type = child.querySelector('[data-type]').value.trim();
    const dim = child.querySelector('[data-dim]').value.trim();
    const title = child.querySelector('[data-title]').value.trim();
    const note = child.querySelector('[data-note]').value.trim();
    const extra = child.querySelector('[data-extra]').value.trim();
    const period = (child.querySelector('[data-period]').value || '').trim();

    const priceMode = child.querySelector('[data-price-mode]').value;
    const qtyMode = child.querySelector('[data-qtymode]').value;
    const qty = n(child.querySelector('[data-qty]').value);

    const price = n(child.querySelector('[data-price]').value);
    const discount = n(child.querySelector('[data-discount]').value);
    const fixedTotal = n(child.querySelector('[data-fixed-total]').value);

    let total = 0;
    if(priceMode === 'fixed'){
      total = fixedTotal;
    } else {
      const unit = (discount > 0) ? discount : price;
      total = unit * qty;
    }

    const img = (imagesMode === 'with') ? (child.dataset.img || '') : '';

    items.push({
      type, dim, title, note, period,
      priceMode, qtyMode, qty,
      price, discount, fixedTotal,
      total, img
    });

    if(extra){
      const label = title || type || '‚Äî';
      notes.push({ label, text: extra });
    }
  });

  return { items, notes };
}

function collectDigital(secEl, imagesMode){
  const imgs = (imagesMode === 'with') ? [
    secEl.dataset.dpImg1 || '',
    secEl.dataset.dpImg2 || '',
    secEl.dataset.dpImg3 || ''
  ].filter(Boolean) : [];

  const spots = [];
  secEl.querySelectorAll('[data-dp-spot]').forEach(tr => {
    const seconds = n(tr.querySelector('[data-dp-seconds]').value);
    const price   = n(tr.querySelector('[data-dp-price]').value);
    const promo   = n(tr.querySelector('[data-dp-promo]').value);
    const enabled = tr.querySelector('[data-dp-enabled]').value === 'yes';
    spots.push({ seconds, price, promo, enabled });
  });

  const auds = [];
  secEl.querySelectorAll('[data-dp-aud]').forEach(audEl => {
    const name = (audEl.querySelector('[data-dp-aud-name]').value || '').trim();
    const months = [];
    audEl.querySelectorAll('[data-dp-month]').forEach(tr => {
      const month = tr.querySelector('[data-dp-month-name]').value;
      const panels = n(tr.querySelector('[data-dp-panels]').value);
      const usePromo = tr.querySelector('[data-dp-use-promo]').value === 'yes';
      if(month) months.push({ month, panels, usePromo });
    });
    auds.push({ name, months });
  });

  const noteEnabled = secEl.querySelector('[data-dp-note-enabled]').value === 'yes';
  const noteText = (secEl.querySelector('[data-dp-note-text]').value || '').trim();

  return { imgs, spots, auds, noteEnabled, noteText };
}

function collectState(){
  const title = document.getElementById('offerTitle').value.trim() || 'Cenov√° ponuka';
  const subtitle = document.getElementById('offerSubtitle').value.trim();
  const imagesMode = document.getElementById('pdfImages').value;
  const showGrand = document.getElementById('pdfShowGrand').value === 'yes';
  const stdNoteEnabled = document.getElementById('stdNoteEnabled').value === 'yes';

  const sections = [];

  sectionsWrap.querySelectorAll('[data-section]').forEach(secEl => {
    const secName = secEl.querySelector('[data-sec-name]').value.trim();
    const secPeriod = secEl.querySelector('[data-sec-period]').value.trim();
    const kind = secEl.querySelector('[data-sec-kind]').value;

    if(kind === 'digital'){
      const dp = collectDigital(secEl, imagesMode);
      sections.push({ kind, secName, secPeriod, dp });
    } else {
      const std = collectStandardItems(secEl, imagesMode);
      sections.push({ kind, secName, secPeriod, items: std.items, notes: std.notes });
    }
  });

  return { title, subtitle, imagesMode, showGrand, stdNoteEnabled, sections };
}

function renderPDF(){
  const state = collectState();

  document.getElementById('pvTitle').textContent = state.title;
  document.getElementById('pvSubtitle').textContent = state.subtitle;

  const printPage = document.getElementById('printPage');
  if(state.imagesMode === 'without') printPage.classList.add('pv-no-images');
  else printPage.classList.remove('pv-no-images');

  const pvLogo = document.getElementById('pvLogo');
  pvLogo.onerror = () => { pvLogo.style.display = 'none'; };
  pvLogo.style.display = 'block';

  const pvGutter = document.getElementById('pvGutter');
  pvGutter.innerHTML = '';
  if(state.imagesMode === 'with'){
    state.sections.forEach(s => {
      if(s.kind === 'digital'){
        (s.dp.imgs || []).forEach(src => {
          const box = document.createElement('div');
          box.className = 'pv-img';
          const img = document.createElement('img');
          img.src = src;
          box.appendChild(img);
          pvGutter.appendChild(box);
        });
      } else {
        (s.items || []).forEach(it => {
          if(it.__or) return;
          if(!it.img) return;
          const box = document.createElement('div');
          box.className = 'pv-img';
          const img = document.createElement('img');
          img.src = it.img;
          box.appendChild(img);
          pvGutter.appendChild(box);
        });
      }
    });
  }

  const pvSections = document.getElementById('pvSections');
  pvSections.innerHTML = '';

  let grandTotal = 0;
  let grandHasMax = false;

  state.sections.forEach(s => {
    const secDiv = document.createElement('div');
    secDiv.className = 'pv-section';

    const name = document.createElement('div');
    name.className = 'pv-section-name';
    name.textContent = s.secName || '';
    secDiv.appendChild(name);

    const per = document.createElement('div');
    per.className = 'pv-section-period';
    per.textContent = s.secPeriod || '';
    secDiv.appendChild(per);

    if(s.kind === 'digital'){
      const activeSpots = (s.dp.spots || [])
        .filter(x => x.enabled)
        .filter(x => (x.price > 0 || x.promo > 0))
        .sort((a,b) => a.seconds - b.seconds)
        .slice(0, 3);

      const block1 = document.createElement('div');
      block1.className = 'pv-block-title';
      block1.textContent = 'Digit√°lny panel v ƒçak√°rni lek√°ra';
      secDiv.appendChild(block1);

      const tbl1 = document.createElement('table');
      tbl1.className = 'pv-dp-table';
      const thead = document.createElement('thead');
      thead.innerHTML = `
        <tr>
          <th style="width:55%;">N√°zov</th>
          <th style="width:15%;" class="c">Poƒçet sek√∫nd</th>
          <th style="width:30%;" class="r">Cena / 1 panel / mesiac</th>
        </tr>`;
      tbl1.appendChild(thead);

      const tbody = document.createElement('tbody');
      if(activeSpots.length === 0){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="3">‚Äî</td>`;
        tbody.appendChild(tr);
      } else {
        activeSpots.forEach(sp => {
          const tr = document.createElement('tr');

          const nameTd = document.createElement('td');
          nameTd.textContent = 'Spot v digit√°lnom paneli';
          tr.appendChild(nameTd);

          const secTd = document.createElement('td');
          secTd.className = 'c';
          secTd.textContent = String(sp.seconds || 0);
          tr.appendChild(secTd);

          const priceTd = document.createElement('td');
          priceTd.className = 'r';

          const lines = [];
          if(sp.price > 0) lines.push(`<span>${formatMoney(sp.price)}</span>`);
          if(sp.promo > 0) lines.push(`<span class="pv-dp-orange">Zv√Ωhodnen√° cena ${formatMoney(sp.promo)}</span>`);
          priceTd.innerHTML = lines.join('<br>');

          tr.appendChild(priceTd);
          tbody.appendChild(tr);
        });
      }
      tbl1.appendChild(tbody);
      secDiv.appendChild(tbl1);

      (s.dp.auds || []).forEach(aud => {
        const title = document.createElement('div');
        title.className = 'pv-block-title';
        title.textContent = aud.name || '';
        secDiv.appendChild(title);

        const tbl = document.createElement('table');
        tbl.className = 'pv-dp-table';

        const thead2 = document.createElement('thead');
        const trh = document.createElement('tr');

        const thTerm = document.createElement('th'); thTerm.style.width = '26%'; thTerm.textContent = 'Term√≠n';
        const thPanels = document.createElement('th'); thPanels.style.width = '16%'; thPanels.className = 'r'; thPanels.textContent = 'Poƒçet panelov';
        trh.appendChild(thTerm);
        trh.appendChild(thPanels);

        const colW = activeSpots.length ? Math.floor(58 / activeSpots.length) : 0;
        activeSpots.forEach(sp => {
          const th = document.createElement('th');
          th.style.width = colW + '%';
          th.className = 'r';
          th.textContent = `Cena spolu za ${sp.seconds} sekundov√Ω spot`;
          trh.appendChild(th);
        });

        thead2.appendChild(trh);
        tbl.appendChild(thead2);

        const tbody2 = document.createElement('tbody');

        // sums per column
        const sums = activeSpots.map(() => 0);

        (aud.months || []).forEach(m => {
          const tr = document.createElement('tr');

          const tdM = document.createElement('td');
          tdM.textContent = m.month || '';
          tr.appendChild(tdM);

          const tdP = document.createElement('td');
          tdP.className = 'r';
          tdP.textContent = String(m.panels || 0);
          tr.appendChild(tdP);

          activeSpots.forEach((sp, idx) => {
            const canPromo = (sp.promo > 0);
            const usePromo = !!m.usePromo && canPromo;

            const unit = usePromo ? sp.promo : sp.price;
            const total = (m.panels || 0) * (unit || 0);

            sums[idx] += total;

            const td = document.createElement('td');
            td.className = 'r';
            td.innerHTML = `<span class="${usePromo ? 'pv-dp-orange' : ''}">${formatMoney(total)}</span>`;
            tr.appendChild(td);

            // global grand (optional overall)
            grandTotal += total;
          });

          tbody2.appendChild(tr);
        });

        // totals row under each spot column (NOT combined)
        if(activeSpots.length > 0){
          const trTot = document.createElement('tr');
          trTot.className = 'pv-dp-total-row';

          const tdLbl = document.createElement('td');
          tdLbl.textContent = 'Spolu';
          trTot.appendChild(tdLbl);

          const tdBlank = document.createElement('td');
          tdBlank.textContent = '';
          trTot.appendChild(tdBlank);

          sums.forEach(val => {
            const td = document.createElement('td');
            td.className = 'r';
            td.innerHTML = `<strong>${formatMoney(val)}</strong>`;
            trTot.appendChild(td);
          });

          tbody2.appendChild(trTot);
        }

        tbl.appendChild(tbody2);
        secDiv.appendChild(tbl);
      });

      // DP note at end of DP section
      if(s.dp.noteEnabled && s.dp.noteText){
        const note = document.createElement('div');
        note.className = 'pv-global-note';
        note.innerHTML = `<div class="ttl">S√∫ƒças≈•ou kampane u digit√°lnych panelov je:</div><div>${s.dp.noteText.replaceAll('\n','<br>')}</div>`;
        secDiv.appendChild(note);
      }

      const divLine = document.createElement('div');
      divLine.className = 'pv-divider';
      secDiv.appendChild(divLine);

      pvSections.appendChild(secDiv);
      return;
    }

    // STANDARD section table
    const table = document.createElement('table');
    table.className = 'pv-table';

    const thead = document.createElement('thead');
    const trh = document.createElement('tr');

    const headers = [
      { cls:'c-item', txt:'Polo≈æka' },
      { cls:'c-spec', txt:'≈†pecifik√°cia' },
      { cls:'c-qty', txt:'Poƒçet' },
      { cls:'c-price', txt:'Cena' },
      { cls:'c-disc', txt:'Zv√Ωh. cena' },
      { cls:'c-total', txt:'Cena spolu' }
    ];
    headers.forEach(h => {
      const th = document.createElement('th');
      th.className = h.cls;
      th.textContent = h.txt;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');

    (s.items || []).forEach(it => {
      if(it.__or){
        const trOr = document.createElement('tr');
        trOr.className = 'pv-or-row';
        const td = document.createElement('td');
        td.colSpan = 6;
        td.textContent = 'ALEBO';
        trOr.appendChild(td);
        tbody.appendChild(trOr);
        return;
      }

      const tr = document.createElement('tr');

      const tdItem = document.createElement('td');
      tdItem.className = 'c-item';

      const t = document.createElement('div');
      t.className = 'pv-item-title';
      t.textContent = it.title || it.type || '‚Äî';
      tdItem.appendChild(t);

      if(it.note){
        const nn = document.createElement('div');
        nn.className = 'pv-item-note';
        nn.textContent = it.note;
        tdItem.appendChild(nn);
      }
      if(it.period){
        const pp = document.createElement('div');
        pp.className = 'pv-item-period';
        pp.textContent = it.period;
        tdItem.appendChild(pp);
      }

      tr.appendChild(tdItem);

      const tdSpec = document.createElement('td');
      tdSpec.className = 'c-spec';
      tdSpec.textContent = it.dim || '';
      tr.appendChild(tdSpec);

      const tdQty = document.createElement('td');
      tdQty.className = 'c-qty';
      tdQty.textContent = it.qtyMode === 'max' ? ('max. ' + (it.qty || 0)) : String(it.qty || 0);
      tr.appendChild(tdQty);

      const tdPrice = document.createElement('td');
      tdPrice.className = 'c-price';

      if(it.priceMode === 'fixed'){
        tdPrice.textContent = it.fixedTotal > 0 ? formatMoney(it.fixedTotal) : '';
      } else {
        if(it.discount > 0 && it.price > 0){
          const old = document.createElement('div');
          old.style.textDecoration = 'line-through';
          old.style.color = '#777';
          old.style.fontSize = '10.5px';
          old.textContent = formatMoney(it.price);
          tdPrice.appendChild(old);
        } else {
          tdPrice.textContent = it.price > 0 ? formatMoney(it.price) : '';
        }
      }
      tr.appendChild(tdPrice);

      const tdDisc = document.createElement('td');
      tdDisc.className = 'c-disc';
      if(it.priceMode === 'fixed'){
        tdDisc.textContent = '';
      } else {
        tdDisc.textContent = it.discount > 0 ? formatMoney(it.discount) : '';
      }
      tr.appendChild(tdDisc);

      const tdTotal = document.createElement('td');
      tdTotal.className = 'c-total';
      const strong = document.createElement('strong');
      const shown = it.qtyMode === 'max' ? ('max. ' + formatMoney(it.total)) : formatMoney(it.total);
      strong.textContent = shown;
      tdTotal.appendChild(strong);
      tr.appendChild(tdTotal);

      grandTotal += it.total;
      if(it.qtyMode === 'max') grandHasMax = true;

      tbody.appendChild(tr);
    });

    table.appendChild(tbody);
    secDiv.appendChild(table);

    // notes at end of standard section (moved extras here)
    if((s.notes || []).length){
      const notes = document.createElement('div');
      notes.className = 'pv-notes';
      notes.innerHTML = `<div class="ttl">Pozn√°mky</div>`;
      (s.notes || []).forEach(nn => {
        const ln = document.createElement('div');
        ln.className = 'ln';
        ln.innerHTML = `<span class="lbl">${nn.label}:</span> ${nn.text}`;
        notes.appendChild(ln);
      });
      secDiv.appendChild(notes);
    }

    const divLine = document.createElement('div');
    divLine.className = 'pv-divider';
    secDiv.appendChild(divLine);

    pvSections.appendChild(secDiv);
  });

  // optional grand total
  const pvGrandWrap = document.getElementById('pvGrandWrap');
  pvGrandWrap.innerHTML = '';
  if(state.showGrand){
    const grand = document.createElement('div');
    grand.className = 'pv-grand';
    const box = document.createElement('div');
    box.className = 'pv-grand-box';
    const val = (grandHasMax ? ('max. ' + formatMoney(grandTotal)) : formatMoney(grandTotal));
    box.innerHTML = `<div class="lbl">Spolu</div><div class="val">${val}</div>`;
    grand.appendChild(box);
    pvGrandWrap.appendChild(grand);
  }

  // global notes (standard + always VAT)
  const pvGlobalNotes = document.getElementById('pvGlobalNotes');
  pvGlobalNotes.innerHTML = '';

  if(state.stdNoteEnabled){
    const block = document.createElement('div');
    block.className = 'pv-global-note';
    block.innerHTML = `
      <div class="ttl">S√∫ƒças≈•ou kampane je:</div>
      <div>S√∫ƒças≈•ou kampane je kompletn√° fotodokument√°cia pl√¥ch.</div>
      <div>V pr√≠pade odovzdania z√°sielok je s√∫ƒças≈•ou kampane kompletn√Ω zoznam odovzdan√Ωch z√°sielok.</div>
    `;
    pvGlobalNotes.appendChild(block);
  }

  // VAT line exists always (already in HTML)
}

/* ========= BUTTONS ========= */
document.getElementById('btnAddSection').addEventListener('click', addSection);
document.getElementById('btnAddSectionBottom').addEventListener('click', addSection);

document.getElementById('btnPrint').addEventListener('click', () => {
  renderPDF();
  setTimeout(() => window.print(), 80);
});

document.getElementById('btnReset').addEventListener('click', () => {
  document.getElementById('offerTitle').value = 'Cenov√° ponuka';
  document.getElementById('offerSubtitle').value = '';
  document.getElementById('pdfImages').value = 'with';
  document.getElementById('pdfShowGrand').value = 'yes';
  document.getElementById('stdNoteEnabled').value = 'yes';
  sectionsWrap.innerHTML = '';
  applyImagesSetting();
  addSection();
});

/* ========= INIT ========= */
applyImagesSetting();
addSection();
</script>

</body>
</html>
